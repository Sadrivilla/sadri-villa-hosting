<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin | Hero Images</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicon.png">

<style>
* { box-sizing: border-box }

body {
  margin: 0;
  padding: 16px;
  font-family: Arial, sans-serif;
  background: #f1f5f9;
  color: #0f172a;
}

/* TOP BAR */
.top-bar {
  margin-bottom: 14px;
}
.back-btn {
  background: linear-gradient(135deg, #93c5fd, #60a5fa);
  color: #fff;
  border: none;
  padding: 8px 14px;
  border-radius: 10px;
  cursor: pointer;
}

/* CARD */
.hero-admin-card {
  max-width: 720px;
  margin: auto;
  background: #ffffff;
  padding: 18px;
  border-radius: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.08);
}

.upload-box {
  display: inline-block;
  padding: 14px 20px;
  border: 2px dashed #93c5fd;
  border-radius: 12px;
  color: #2563eb;
  cursor: pointer;
}

.btn-gradient {
  width: 100%;
  margin-top: 10px;
  padding: 12px;
  border: none;
  border-radius: 12px;
  background: linear-gradient(135deg, #60a5fa, #38bdf8);
  color: #fff;
  font-weight: 600;
  cursor: pointer;
}

.hero-images-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 12px;
  margin-top: 18px;
}

.hero-card {
  background: #fff;
  border-radius: 14px;
  overflow: hidden;
  box-shadow: 0 6px 18px rgba(0,0,0,0.08);
}

.hero-card img {
  width: 100%;
  height: 120px;
  object-fit: cover;
}

.hero-card-actions {
  padding: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.delete-btn {
  background: #fee2e2;
  color: #b91c1c;
  border: none;
  padding: 6px 10px;
  border-radius: 8px;
  font-size: 13px;
  cursor: pointer;
}

/* TOGGLE */
.switch {
  position: relative;
  width: 42px;
  height: 22px;
}
.switch input { display: none }
.slider {
  position: absolute;
  inset: 0;
  background: #cbd5f5;
  border-radius: 999px;
}
.slider::before {
  content: "";
  position: absolute;
  width: 16px;
  height: 16px;
  left: 3px;
  bottom: 3px;
  background: #fff;
  border-radius: 50%;
  transition: .2s;
}
.switch input:checked + .slider {
  background: linear-gradient(135deg, #60a5fa, #38bdf8);
}
.switch input:checked + .slider::before {
  transform: translateX(20px);
}
</style>
</head>

<body>

<div class="top-bar">
  <button class="back-btn" onclick="location.href='admin.html'">‚Üê Back</button>
</div>

<div class="hero-admin-card">
  <h3>üñº Hero Images</h3>

  <label class="upload-box">
    <input type="file" id="heroImagesInput" accept="image/*" multiple hidden>
    üì§ Select Images
  </label>

  <button class="btn-gradient" onclick="uploadHeroImages()">Upload Images</button>

  <p id="heroMsg"></p>
  <div id="progressContainer" style="display:none; margin-top:10px;">
  <div style="background:#e2e8f0; border-radius:8px; overflow:hidden;">
    <div id="progressBar" style="
      width:0%;
      height:12px;
      background:linear-gradient(135deg,#60a5fa,#38bdf8);
      transition:width .3s;">
    </div>
  </div>
  <small id="progressText">0%</small>
</div>

  <div id="previewList" class="hero-images-list"></div>


  <div id="heroImagesList" class="hero-images-list"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import { 
  getFirestore, 
  doc, 
  onSnapshot, 
  updateDoc,
  getDoc 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* FIREBASE INIT */
const app = initializeApp({
  apiKey: "AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain: "sadri-villa-14c06.firebaseapp.com",
  projectId: "sadri-villa-14c06"
});

const auth = getAuth(app);
const db = getFirestore(app);

const heroImagesInput = document.getElementById("heroImagesInput");
const heroMsg = document.getElementById("heroMsg");
const list = document.getElementById("heroImagesList");
const previewList = document.getElementById("previewList");
const homeRef = doc(db, "siteSettings", "home");

/* AUTH + ROLE CHECK */
onAuthStateChanged(auth, async (user) => {
  if (!user) return location.href="login.html";

  const snap = await getDoc(doc(db,"users",user.uid));
  if (!snap.exists() || snap.data().role !== "admin") {
    alert("Admin only");
    location.href="dashboard.html";
  }
});

/* IMAGE PREVIEW BEFORE UPLOAD */
heroImagesInput.addEventListener("change", () => {

  previewList.innerHTML = "";

  const files = heroImagesInput.files;
  if (!files.length) return;

  Array.from(files).forEach((file, index) => {

    const reader = new FileReader();
    reader.onload = e => {

      const div = document.createElement("div");
      div.className = "hero-card";

      div.innerHTML = `
        <img src="${e.target.result}">
        <div class="hero-card-actions">
          <span style="font-size:12px;">Preview</span>
          <button class="delete-btn" onclick="removePreview(${index})">
            Remove
          </button>
        </div>
      `;

      previewList.appendChild(div);
    };

    reader.readAsDataURL(file);
  });
});

/* REMOVE PREVIEW */
window.removePreview = (index) => {

  const dt = new DataTransfer();
  const files = heroImagesInput.files;

  Array.from(files).forEach((file, i) => {
    if (i !== index) dt.items.add(file);
  });

  heroImagesInput.files = dt.files;
  heroImagesInput.dispatchEvent(new Event("change"));
};

/* LIVE LOAD EXISTING IMAGES */
onSnapshot(homeRef, (snap) => {

  list.innerHTML = "";
  if (!snap.exists()) return;

  const images = snap.data().heroimages || [];

  images.forEach((img, i) => {

    const div = document.createElement("div");
    div.className = "hero-card";

    div.innerHTML = `
      <img src="${img.url}">
      <div class="hero-card-actions">
        <label class="switch">
          <input type="checkbox" ${img.enabled ? "checked" : ""}
            onchange="toggleHero(${i})">
          <span class="slider"></span>
        </label>
        <button class="delete-btn" onclick="deleteHero(${i})">
          Delete
        </button>
      </div>
    `;

    list.appendChild(div);
  });
});

/* UPLOAD VIA CLOUD FUNCTION */
window.uploadHeroImages = async () => {

  const files = heroImagesInput.files;

  if (!files.length) {
    heroMsg.textContent = "‚ùå Please select images";
    return;
  }

  const progressContainer = document.getElementById("progressContainer");
  const progressBar = document.getElementById("progressBar");
  const progressText = document.getElementById("progressText");

  progressContainer.style.display = "block";
  progressBar.style.width = "0%";
  progressText.textContent = "0%";

  heroMsg.textContent = "Uploading...";

  const user = auth.currentUser;
  const token = await user.getIdToken(true);

  let uploaded = 0;

  for (let file of files) {

    const base64 = await new Promise(res => {
      const r = new FileReader();
      r.onload = () => res(r.result.split(",")[1]);
      r.readAsDataURL(file);
    });

    const response = await fetch(
      "https://uploadheroimage-jgzkr3mifq-uc.a.run.app",
      {
        method: "POST",
        headers: {
          "Authorization": "Bearer " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          fileBase64: base64,
          mimeType: file.type
        })
      }
    );

    if (!response.ok) {
      heroMsg.textContent = "‚ùå Upload failed";
      progressContainer.style.display = "none";
      return;
    }

    uploaded++;

    const percent = Math.round((uploaded / files.length) * 100);
    progressBar.style.width = percent + "%";
    progressText.textContent = percent + "%";
  }

  heroMsg.textContent = "‚úÖ Images uploaded successfully";

  setTimeout(() => {
    progressContainer.style.display = "none";
    progressBar.style.width = "0%";
    progressText.textContent = "0%";
  }, 1000);

  heroImagesInput.value = "";
  previewList.innerHTML = "";
};


/* TOGGLE */
window.toggleHero = async (index) => {

  const snap = await getDoc(homeRef);
  const imgs = snap.data().heroimages || [];

  imgs[index].enabled = !imgs[index].enabled;

  await updateDoc(homeRef, { heroimages: imgs });
};

/* DELETE */
window.deleteHero = async (index) => {

  if (!confirm("Delete this image?")) return;

  const snap = await getDoc(homeRef);
  const imgs = snap.data().heroimages || [];

  imgs.splice(index, 1);

  await updateDoc(homeRef, { heroimages: imgs });
};
</script>


</body>
</html>
