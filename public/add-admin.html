<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Add Admin | Sadri Villa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="/assets/navbar.css">

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:Arial,sans-serif;
  background:#ffffff;
  color:#0f172a;
}

/* ===== FORM CARD ===== */
.container{
  max-width:460px;
  margin:130px auto 60px;
  padding:34px 30px;
  border-radius:28px;
  background:#f8fbff;
  box-shadow:0 25px 55px rgba(0,0,0,.15);
}
h2{text-align:center;margin-bottom:26px;font-size:24px}

label{
  display:block;
  margin-top:16px;
  font-weight:600;
  font-size:14px;
}
input{
  width:100%;
  padding:14px 16px;
  margin-top:6px;
  border-radius:14px;
  border:1px solid #cbd5e1;
  font-size:15px;
}
input:focus{
  outline:none;
  border-color:#38bdf8;
}

button{
  width:100%;
  margin-top:26px;
  padding:14px;
  border:none;
  border-radius:999px;
  font-size:16px;
  font-weight:700;
  cursor:pointer;
  color:#fff;
  background:linear-gradient(135deg,#38bdf8,#60a5fa);
  box-shadow:0 14px 30px rgba(56,189,248,.45);
  transition:.25s;
}
button:hover{
  transform:translateY(-2px);
  box-shadow:0 20px 44px rgba(56,189,248,.6);
}

.msg{
  margin-top:18px;
  text-align:center;
  font-size:14px;
}
.success{color:#16a34a}
.error{color:#dc2626}
</style>
</head>

<body>

<!-- GLOBAL NAVBAR -->
<div id="navbar-container"></div>

<!-- FORM -->
<div class="container">
  <h2>âž• Add New Admin</h2>

  <label>Full Name</label>
  <input id="name" placeholder="Admin name">

  <label>Email</label>
  <input id="email" type="email" placeholder="admin@email.com">

  <label>Temporary Password</label>
  <input id="password" type="password" placeholder="Min 6 characters">

  <button onclick="createAdmin()">Create Admin</button>

  <div id="msg" class="msg"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged,
  createUserWithEmailAndPassword 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { 
  getFirestore, 
  doc, 
  getDoc,
  setDoc, 
  serverTimestamp,
  onSnapshot
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ===== FIREBASE INIT ===== */
const app = initializeApp({
  apiKey:"AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain:"sadri-villa-14c06.firebaseapp.com",
  projectId:"sadri-villa-14c06"
});

const auth = getAuth();
const db = getFirestore();

/* ===== ADMIN ACCESS CONTROL ===== */
onAuthStateChanged(auth, async (user) => {

  if(!user){
    location.href = "index.html";
    return;
  }

  const snap = await getDoc(doc(db,"users",user.uid));

  if(!snap.exists() || snap.data().role !== "admin"){
    location.href = "index.html";
    return;
  }

});

/* ===== REALTIME LOGO ===== */
onSnapshot(doc(db,"siteSettings","home"), snap => {
  if(!snap.exists()) return;
  const data = snap.data();
  const logo = document.getElementById("siteLogo");
  if(!logo) return;

  if(data.logo?.url){
    const v = data.logo.updatedAt?.seconds || Date.now();
    const img = new Image();
    img.src = data.logo.url + "?v=" + v;

    img.onload = () => {
      logo.src = img.src;
      logo.style.display = "block";
    };
  }
});

/* ===== CREATE ADMIN ===== */
window.createAdmin = async () => {

  const msg = document.getElementById("msg");
  msg.textContent="";
  msg.className="msg";

  const nameEl = document.getElementById("name");
  const emailEl = document.getElementById("email");
  const passEl = document.getElementById("password");

  const name = nameEl.value.trim();
  const email = emailEl.value.trim();
  const password = passEl.value;

  if(!name || !email || password.length < 6){
    msg.textContent="Please fill all fields correctly";
    msg.classList.add("error");
    return;
  }

  try{
    const cred = await createUserWithEmailAndPassword(auth,email,password);

    await setDoc(doc(db,"users",cred.user.uid),{
      fullName:name,
      email,
      role:"admin",
      approved:true,
      createdAt: serverTimestamp()
    });

    msg.textContent="Admin created successfully.";
    msg.classList.add("success");

    nameEl.value="";
    emailEl.value="";
    passEl.value="";
  }
  catch(err){
    msg.textContent=err.message;
    msg.classList.add("error");
  }
};
</script>

<script>
/* LOAD GLOBAL NAVBAR */
fetch("/components/navbar.html")
  .then(res => res.text())
  .then(data => {
    document.getElementById("navbar-container").innerHTML = data;
  });

function toggleMenu(e){
  e.stopPropagation();
  document.getElementById("mobileMenu").classList.toggle("active");
}

document.addEventListener("click",function(){
  const menu = document.getElementById("mobileMenu");
  if(menu) menu.classList.remove("active");
});
</script>

</body>
</html>
