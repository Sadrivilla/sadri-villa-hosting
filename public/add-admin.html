const { onCall, HttpsError } = require("firebase-functions/v2/https");
const admin = require("firebase-admin");

admin.initializeApp();

exports.addAdmin = onCall(
  { region: "us-central1" },
  async (request) => {

    // ğŸ” Must be logged in
    if (!request.auth) {
      throw new HttpsError("unauthenticated", "Login required");
    }

    // ğŸ” Caller must already be admin
    if (request.auth.token.admin !== true) {
      throw new HttpsError("permission-denied", "Admin only");
    }

    const { uid } = request.data;
    if (!uid) {
      throw new HttpsError("invalid-argument", "UID is required");
    }

    // âœ… Ensure user exists
    let user;
    try {
      user = await admin.auth().getUser(uid);
    } catch {
      throw new HttpsError("not-found", "User does not exist");
    }

    // âœ… Preserve existing claims + add admin
    await admin.auth().setCustomUserClaims(uid, {
      ...(user.customClaims || {}),
      admin: true
    });

    return {
      success: true,
      message: "Admin role assigned successfully"
    };
  }
);
