<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pending Approval Requests â€“ Sadri Villa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicon.png">

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#eef2ff;
}

/* HEADER */
.header{
  padding:22px;
  background:linear-gradient(135deg,#4f46e5,#7c3aed);
  color:#fff;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.header h2{margin:0}
.back-btn{
  background:#fff;
  color:#4f46e5;
  border:none;
  padding:10px 16px;
  border-radius:14px;
  font-weight:600;
  cursor:pointer;
}

/* CONTAINER */
.container{
  padding:22px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(360px,1fr));
  gap:20px;
}

/* CARD */
.card{
  background:#fff;
  border-radius:22px;
  padding:22px;
  box-shadow:0 15px 35px rgba(0,0,0,.12);
}
.card h3{margin-top:0}

/* BADGES */
.badge{
  display:inline-block;
  padding:4px 12px;
  border-radius:999px;
  font-size:12px;
  margin-top:8px;
}
.pending{background:#fde68a;color:#92400e}
.approved{background:#bbf7d0;color:#065f46}

/* BUTTONS */
.approve-btn{
  margin-top:14px;
  padding:10px 18px;
  border:none;
  border-radius:14px;
  background:#16a34a;
  color:#fff;
  font-size:15px;
  cursor:pointer;
}
.approve-btn:disabled{
  opacity:.6;
  cursor:not-allowed;
}

/* MESSAGE */
.msg{
  margin:18px 22px;
  padding:14px;
  border-radius:14px;
  display:none;
}
.msg.success{
  background:#dcfce7;
  color:#166534;
}
.msg.error{
  background:#fee2e2;
  color:#991b1b;
}

small{color:#6b7280}
</style>
</head>

<body>

<!-- HEADER -->
<div class="header">
  <h2>ðŸ”” Pending Approval Requests</h2>
  <button class="back-btn" onclick="location.href='admin-dashboard.html'">
    â¬… Back
  </button>
</div>

<div id="message" class="msg"></div>

<div class="container" id="list"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getAuth,
  onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
  getFirestore,
  collection,
  query,
  where,
  onSnapshot,
  doc,
  updateDoc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* FIREBASE */
const app = initializeApp({
  apiKey:"AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain:"sadri-villa-14c06.firebaseapp.com",
  projectId:"sadri-villa-14c06"
});
const auth = getAuth(app);
const db = getFirestore(app);

/* ADMIN CHECK */
onAuthStateChanged(auth, async user=>{
  if(!user){
    location.href="login.html";
    return;
  }

  const snap = await getDoc(doc(db,"users",user.uid));
  if(!snap.exists() || snap.data().role!=="admin"){
    alert("Access denied");
    location.href="dashboard.html";
    return;
  }

  initRealtimeRequests();
});

/* REALTIME REQUESTS */
function initRealtimeRequests(){

  const q = query(
    collection(db,"users"),
    where("approved","!=",true),
    where("approvalReminder","==",true)
  );

  onSnapshot(q, snapshot=>{
    list.innerHTML="";

    if(snapshot.empty){
      list.innerHTML="<p>No pending approval requests ðŸŽ‰</p>";
      return;
    }

    snapshot.forEach(docSnap=>{
      const u = {id:docSnap.id,...docSnap.data()};

      const card = document.createElement("div");
      card.className="card";
      card.innerHTML=`
        <h3>${u.fullName || "User"}</h3>
        <p><b>Email:</b> ${u.email || "â€”"}</p>
        <p><b>Mobile:</b> ${u.phone || "â€”"}</p>
        <span class="badge pending">Pending</span><br>
        <button class="approve-btn" onclick="approveUser('${u.id}','${u.fullName || "User"}',this)">
          Approve
        </button>
      `;
      list.appendChild(card);
    });
  });
}

/* APPROVE */
window.approveUser = async (uid,name,btn)=>{
  btn.disabled=true;

  await updateDoc(doc(db,"users",uid),{
    approved:true,
    approvalReminder:false,
    approvedAt:new Date().toISOString()
  });

  showMessage(`âœ… User <b>${name}</b> approved successfully`);
};

/* MESSAGE */
function showMessage(text){
  message.innerHTML=text;
  message.className="msg success";
  message.style.display="block";

  setTimeout(()=>{
    message.style.display="none";
  },4000);
}
</script>

</body>
</html>
