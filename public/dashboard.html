<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth,onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore,doc,onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

document.addEventListener("DOMContentLoaded", () => {

  const firebaseConfig = {
    apiKey: "AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
    authDomain: "sadri-villa-14c06.firebaseapp.com",
    projectId: "sadri-villa-14c06",
    storageBucket: "sadri-villa-14c06.appspot.com"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  /* PROFILE DROPDOWN (SAFE) */
  const profilePhoto = document.getElementById("profilePhoto");
  const profileCard = document.getElementById("profileCard");

  if (profilePhoto && profileCard) {
    profilePhoto.addEventListener("click", () => {
      profileCard.classList.toggle("show");
    });

    document.addEventListener("click", e => {
      if (!e.target.closest(".profile-wrapper")) {
        profileCard.classList.remove("show");
      }
    });
  }

  /* AUTH + LIVE USER */
  onAuthStateChanged(auth,user=>{
    if(!user){
      location.href="login.html";
      return;
    }

    onSnapshot(doc(db,"users",user.uid),snap=>{
      const data=snap.data();
      if(!data) return;

      const welcomeName = document.getElementById("welcomeName");
      if(welcomeName){
        welcomeName.innerText =
          "Welcome " + (data.fullName||"Member").split(" ")[0];
      }

      if(data.profilePhoto && profilePhoto){
        profilePhoto.src = data.profilePhoto + "?v=" + Date.now();
      }

      loadDashboard(data);
    });
  });

  /* DASHBOARD LOGIC */
  function loadDashboard(data){

    let userTotal=2;
    let userFilled=0;
    if(data.fullName) userFilled++;
    if(data.phone) userFilled++;

    let adminTotal=Object.keys(data.adminFields||{}).length;
    let adminFilled=Object.values(data.adminFields||{}).filter(v=>v).length;

    let customTotal=Object.keys(data.userCustomFields||{}).length;
    let customFilled=Object.values(data.userCustomFields||{}).filter(v=>v.value).length;

    const total=userTotal+adminTotal+customTotal;
    const filled=userFilled+adminFilled+customFilled;

    const percent=Math.round((filled/(total||1))*100);
    animatePercent(percent);

    const groupInfo = document.getElementById("groupInfo");
    if(groupInfo){
      groupInfo.innerText =
        `User ${userFilled}/${userTotal} | Admin ${adminFilled}/${adminTotal} | Custom ${customFilled}/${customTotal}`;
    }

    const memberDays = document.getElementById("memberDays");
    if(data.createdAt && memberDays){
      memberDays.innerText =
        Math.floor((Date.now()-new Date(data.createdAt))/(86400000))+" days";
    }

    const lastLogin = document.getElementById("lastLogin");
    if(lastLogin){
      lastLogin.innerText =
        data.lastLogin
          ? new Date(data.lastLogin).toLocaleDateString("en-IN")
          : "First login";
    }

    const customDashboard = document.getElementById("customDashboard");
    if(customDashboard){
      customDashboard.innerHTML="";
      Object.entries(data.userCustomFields||{}).forEach(([k,v])=>{
        if(v.showOnDashboard){
          customDashboard.innerHTML+=`
            <div class="qa-card">
              <h4>${k}</h4>
              <p>${v.value}</p>
            </div>
          `;
        }
      });
    }
  }

  function animatePercent(target){
    let current=0;
    const percentEl=document.getElementById("percent");
    const bar=document.getElementById("bar");
    if(!percentEl || !bar) return;

    const interval=setInterval(()=>{
      if(current>=target){
        clearInterval(interval);
      }
      percentEl.innerText=current+"%";
      bar.style.width=current+"%";
      current++;
    },10);
  }

  /* LOGOUT */
  window.logout=async()=>{
    await signOut(auth);
    location.href="login.html";
  };

});
</script>

</body>
</html>
