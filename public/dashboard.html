<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>User Dashboard | Sadri Villa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
html,body{
  margin:0;
  font-family:Arial,sans-serif;
  background:#eef2ff;
}

/* ================= NAVBAR ================= */
.navbar{
  position:sticky;
  top:0;
  height:72px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 24px;
  background:#fff;
  box-shadow:0 8px 20px rgba(0,0,0,.08);
  z-index:1000;
}

.nav-left{display:flex;align-items:center;gap:12px;}

#siteLogo{height:44px;display:none;}

.nav-title span{
  font-size:13px;
  color:#64748b;
}

.profile-wrapper{position:relative;cursor:pointer;}
.profile-photo{
  width:46px;height:46px;border-radius:50%;
  object-fit:cover;border:3px solid #38bdf8;
}
.profile-card{
  position:absolute;right:0;top:60px;
  width:220px;background:#fff;
  border-radius:18px;
  box-shadow:0 20px 45px rgba(0,0,0,.2);
  padding:14px;
  display:none;flex-direction:column;gap:10px;
}
.profile-card.show{display:flex;}
.profile-card button{
  padding:10px;border:none;border-radius:10px;
  cursor:pointer;background:#f1f5f9;
}

/* ================= DASHBOARD GRID ================= */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:20px;
  padding:24px;
}

.card{
  background:#fff;
  border-radius:22px;
  padding:24px;
  box-shadow:0 15px 35px rgba(0,0,0,.12);
}

.progress{
  height:14px;
  background:#e5e7eb;
  border-radius:20px;
  overflow:hidden;
}
.progress div{
  height:100%;
  width:0%;
  transition:width 1s ease;
}

/* ================= CUSTOM DASHBOARD Q&A ================= */
.qa-card{
  background:#fff;
  border-radius:20px;
  padding:18px;
  box-shadow:0 10px 25px rgba(0,0,0,.1);
}
.qa-card h4{
  margin:0 0 6px;
  color:#2563eb;
}

/* ================= SLIDER ================= */
.gallery{
  background:#fff;
  padding:40px 0;
  overflow:hidden;
}
.track{
  display:flex;
  gap:24px;
  padding-left:24px;
  width:max-content;
}
.track.animate{
  animation:scroll 25s linear infinite;
}
.track.pause{
  animation-play-state:paused;
}
.img-wrap{position:relative;}
.track img{
  width:320px;height:200px;
  object-fit:cover;
  border-radius:20px;
}
.download-btn{
  position:absolute;
  bottom:10px;right:10px;
  background:#2563eb;color:#fff;
  padding:6px 10px;
  border-radius:10px;
  font-size:12px;
  opacity:0;
  transition:.3s;
}
.img-wrap:hover .download-btn{
  opacity:1;
}
@keyframes scroll{
  from{transform:translateX(0)}
  to{transform:translateX(-50%)}
}

/* ================= MODAL ================= */
.modal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.7);
  align-items:center;
  justify-content:center;
  z-index:5000;
}
.modal img{
  max-width:90vw;
  max-height:80vh;
  border-radius:20px;
}
</style>
</head>

<body>

<!-- NAVBAR -->
<div class="navbar">
  <div class="nav-left">
    <img id="siteLogo">
    <div class="nav-title">
      <b>Sadri Villa</b><br>
      <span id="welcomeName">Welcome</span>
    </div>
  </div>

  <div class="profile-wrapper">
    <img id="profilePhoto" class="profile-photo"
      src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
    <div class="profile-card" id="profileCard">
      <button onclick="location.href='profile.html'">Profile</button>
      <button onclick="logout()">Logout</button>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div class="grid">

  <!-- PROFILE COMPLETION -->
  <div class="card">
    <h3>Profile Completion</h3>
    <h1 id="percent">0%</h1>
    <div class="progress"><div id="bar"></div></div>
    <p id="groupInfo"></p>
    <canvas id="chart" height="160"></canvas>
  </div>

  <!-- MEMBER SINCE -->
  <div class="card">
    <h3>üìÖ Member Since</h3>
    <h2 id="memberDays">-</h2>
  </div>

  <!-- LAST LOGIN -->
  <div class="card">
    <h3>‚è∞ Last Login</h3>
    <h2 id="lastLogin">-</h2>
  </div>

</div>

<!-- CUSTOM FIELDS DASHBOARD SECTION -->
<div class="grid" id="customDashboard"></div>

<!-- SLIDER -->
<section class="gallery" id="gallerySection" style="display:none">
  <div class="track" id="galleryTrack"></div>
</section>

<!-- IMAGE MODAL -->
<div class="modal" id="imgModal" onclick="this.style.display='none'">
  <img id="modalImg">
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth,onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore,doc,onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const app=initializeApp({
  apiKey:"AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain:"sadri-villa-14c06.firebaseapp.com",
  projectId:"sadri-villa-14c06"
});

const auth=getAuth(app);
const db=getFirestore(app);

/* DROPDOWN */
profilePhoto.onclick=()=>profileCard.classList.toggle("show");
document.onclick=e=>{
  if(!e.target.closest(".profile-wrapper"))
    profileCard.classList.remove("show");
};

/* LIVE USER DATA */
onAuthStateChanged(auth,user=>{
  if(!user){location.href="login.html";return;}

  onSnapshot(doc(db,"users",user.uid),snap=>{
    const data=snap.data();
    if(!data)return;

    welcomeName.innerText="Welcome "+(data.fullName||"Member").split(" ")[0];

    if(data.profilePhoto)
      profilePhoto.src=data.profilePhoto+"?v="+Date.now();

    loadDashboard(data);
  });
});

/* DASHBOARD LOGIC */
function loadDashboard(data){

  /* USER GROUP */
  let userTotal=2;
  let userFilled=0;
  if(data.fullName) userFilled++;
  if(data.phone) userFilled++;

  /* ADMIN GROUP */
  let adminTotal=Object.keys(data.adminFields||{}).length;
  let adminFilled=Object.values(data.adminFields||{}).filter(v=>v).length;

  /* CUSTOM GROUP */
  let customTotal=Object.keys(data.userCustomFields||{}).length;
  let customFilled=Object.values(data.userCustomFields||{}).filter(v=>v.value).length;

  const total=userTotal+adminTotal+customTotal;
  const filled=userFilled+adminFilled+customFilled;

  const percent=Math.round((filled/(total||1))*100);

  animatePercent(percent);

  groupInfo.innerText=
    `User ${userFilled}/${userTotal} | Admin ${adminFilled}/${adminTotal} | Custom ${customFilled}/${customTotal}`;

  /* MEMBER DAYS */
  if(data.createdAt){
    memberDays.innerText=
      Math.floor((Date.now()-new Date(data.createdAt))/(86400000))+" days";
  }

  lastLogin.innerText=data.lastLogin
    ? new Date(data.lastLogin).toLocaleDateString("en-IN")
    : "First login";

  /* CUSTOM DASHBOARD Q&A */
  customDashboard.innerHTML="";
  Object.entries(data.userCustomFields||{}).forEach(([k,v])=>{
    if(v.showOnDashboard){
      customDashboard.innerHTML+=`
        <div class="qa-card">
          <h4>${k}</h4>
          <p>${v.value}</p>
        </div>
      `;
    }
  });
}

/* ANIMATED COUNTER */
function animatePercent(target){
  let current=0;
  const interval=setInterval(()=>{
    if(current>=target){clearInterval(interval);}
    percent.innerText=current+"%";
    bar.style.width=current+"%";
    current++;
  },10);
}

/* LIVE LOGO + SLIDER */
onSnapshot(doc(db,"siteSettings","home"),snap=>{
  const logo=snap.data()?.logo;
  if(logo?.url){
    siteLogo.src=logo.url+"?v="+Date.now();
    siteLogo.style.display="block";
  }

  const imgs=(snap.data()?.sliderImages||[])
    .filter(i=>i.enabled!==false);

  galleryTrack.innerHTML="";
  if(!imgs.length){
    gallerySection.style.display="none";
    return;
  }
  gallerySection.style.display="block";

  const list=imgs.length>1?[...imgs,...imgs]:imgs;

  list.forEach(i=>{
    const wrap=document.createElement("div");
    wrap.className="img-wrap";

    const img=document.createElement("img");
    img.src=i.url;
    img.onclick=()=>{modalImg.src=i.url;imgModal.style.display="flex";};

    const link=document.createElement("a");
    link.href=i.url;
    link.download="";
    link.className="download-btn";
    link.innerText="Download";

    wrap.appendChild(img);
    wrap.appendChild(link);
    galleryTrack.appendChild(wrap);
  });

  galleryTrack.classList.toggle("animate",imgs.length>1);
  galleryTrack.onmouseenter=()=>galleryTrack.classList.add("pause");
  galleryTrack.onmouseleave=()=>galleryTrack.classList.remove("pause");
});

/* LOGOUT */
window.logout=async()=>{
  await signOut(auth);
  location.href="login.html";
};
</script>

</body>
</html>
