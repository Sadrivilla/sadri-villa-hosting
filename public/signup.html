<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* FIREBASE */
const app = initializeApp({
  apiKey: "AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain: "sadri-villa-14c06.firebaseapp.com",
  projectId: "sadri-villa-14c06"
});
const auth = getAuth(app);
const db = getFirestore(app);

/* LOGO FROM FIRESTORE */
(async()=>{
  const s = await getDoc(doc(db,"siteSettings","home"));
  if(s.exists() && s.data().logo?.url){
    siteLogo.src = s.data().logo.url;
  }
})();

/* ELEMENTS */
const nameEl = document.getElementById("name");
const phoneEl = document.getElementById("phone");
const emailEl = document.getElementById("email");
const passwordEl = document.getElementById("password");
const confirmPassEl = document.getElementById("confirm");
const msg = document.getElementById("msg");

const steps = [...document.querySelectorAll(".step")];
const bar = document.getElementById("bar");
const stepCount = document.getElementById("stepCount");

let i = 0;

/* STEP CONTROL */
function show(){
  steps.forEach(s=>s.classList.remove("active"));
  steps[i].classList.add("active");
  bar.style.width = ((i+1)/steps.length*100)+"%";
  stepCount.textContent = `Step ${i+1} of ${steps.length}`;
}
show();

window.next = () => {
  msg.style.display="none";
  const map = [nameEl, phoneEl, emailEl, passwordEl];
  const el = map[i];
  el.classList.remove("error");

  if(!el.value.trim()) return fail("Field required", el);
  if(el === phoneEl && !/^[0-9]{10}$/.test(el.value)) return fail("Invalid mobile", el);
  if(el === emailEl && !el.value.includes("@")) return fail("Invalid email", el);

  i++; show();
};

window.prev = () => { i--; show(); };

function fail(text, el){
  msg.className = "msg error";
  msg.textContent = text;
  msg.style.display = "block";
  el.classList.add("error");
  el.focus();
}

/* PASSWORD STRENGTH */
window.checkStrength = () => {
  const p = passwordEl.value;
  let s = 0;
  if(p.length >= 6) s++;
  if(/[A-Z]/.test(p)) s++;
  if(/[0-9]/.test(p)) s++;
  if(/[^A-Za-z0-9]/.test(p)) s++;

  strengthBar.className="";
  if(s <= 1){
    strengthBar.style.width="25%";
    strengthBar.classList.add("weak");
  }else if(s <= 3){
    strengthBar.style.width="60%";
    strengthBar.classList.add("medium");
  }else{
    strengthBar.style.width="100%";
    strengthBar.classList.add("strong");
  }
};

/* ðŸ‘ EYE TOGGLES (FIXED & INDEPENDENT) */
window.togglePass = () => {
  const open = passwordEl.type === "password";
  passwordEl.type = open ? "text" : "password";
  eyePass.classList.toggle("open", open);
};

window.toggleConf = () => {
  const open = confirmPassEl.type === "password";
  confirmPassEl.type = open ? "text" : "password";
  eyeConf.classList.toggle("open", open);
};

/* REGISTER */
window.register = async () => {
  if(passwordEl.value !== confirmPassEl.value){
    return fail("Passwords do not match", confirmPassEl);
  }

  try{
    const cred = await createUserWithEmailAndPassword(
      auth,
      emailEl.value.trim(),
      passwordEl.value
    );

    await setDoc(doc(db,"users",cred.user.uid),{
      fullName: nameEl.value.trim(),
      phone: phoneEl.value.trim(),
      email: emailEl.value.trim(),
      role: "user",
      approved: false,
      createdAt: new Date().toISOString()
    });

    msg.className="msg success";
    msg.textContent="Account created. Pending admin approval.";
    msg.style.display="block";
    setTimeout(()=>location.href="pending.html",2500);

  }catch(e){
    msg.className="msg error";
    msg.textContent = e.message.replace("Firebase: ","");
    msg.style.display="block";
  }
};
</script>
