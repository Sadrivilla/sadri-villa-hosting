<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Profile | Sadri Villa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#eef6ff}
.topbar{display:flex;gap:10px;flex-wrap:wrap;padding:14px 20px;background:#fff}
.btn{background:#38bdf8;color:#fff;border:none;padding:10px 18px;border-radius:12px;font-weight:bold;cursor:pointer}
.wrap{max-width:1100px;margin:auto;padding:24px}
.card{background:#fff;border-radius:24px;padding:28px;box-shadow:0 20px 45px rgba(0,0,0,.12)}
.section{margin-bottom:28px}
.section h3{color:#2563eb;margin-bottom:14px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
@media(max-width:768px){.grid{grid-template-columns:1fr}}
.block{background:#f8fbff;border:1px solid #c7d2fe;padding:14px;border-radius:14px}
input{width:100%;margin-top:6px;padding:10px;border-radius:10px;border:1px solid #d1d5db}
.row{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
.loader{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:9999}
.loader div{width:50px;height:50px;border:6px solid #e5e7eb;border-top:6px solid #38bdf8;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.popup{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:10000}
.popup .box{padding:18px 34px;border-radius:20px;color:#fff;font-weight:bold}
.success{background:#22c55e}
.error{background:#ef4444}
</style>
</head>
<body>

<div class="topbar">
<button class="btn" onclick="location.href='dashboard.html'">Dashboard</button>
<button class="btn" onclick="location.href='profile.html'">Profile</button>
<button class="btn" onclick="exportPDF()">Export PDF</button>
<button class="btn" onclick="exportExcel()">Export Excel</button>
</div>

<div class="wrap">
<div class="card">

<h2>My Profile</h2>

<div class="section">
<h3>User Details</h3>
<div class="grid" id="staticWrap"></div>
</div>

<div class="section">
<h3>Admin Fields</h3>
<div class="grid" id="adminWrap"></div>
</div>

<div class="section">
<h3>Your Custom Fields</h3>
<div id="userWrap"></div>
<button class="btn" onclick="addUserCustom()">Add Custom Field</button>
</div>

<button class="btn" onclick="saveProfile()">Save Profile</button>

</div>
</div>

<div class="loader" id="loader"><div></div></div>
<div class="popup" id="success"><div class="box success">Profile saved</div></div>
<div class="popup" id="error"><div class="box error">Fill required fields</div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore,doc,getDoc,setDoc,collection,getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage,ref,uploadBytes,getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const app=initializeApp({
apiKey:"AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
authDomain:"sadri-villa-14c06.firebaseapp.com",
projectId:"sadri-villa-14c06"
});

const auth=getAuth(app);
const db=getFirestore(app);
const storage=getStorage(app);

const staticWrap=document.getElementById("staticWrap");
const adminWrap=document.getElementById("adminWrap");
const userWrap=document.getElementById("userWrap");
const loader=document.getElementById("loader");

let uid,baseUser={},adminValues={},userCustom={};

const popup=id=>{
const p=document.getElementById(id);
p.style.display="flex";
setTimeout(()=>p.style.display="none",2000);
};

onAuthStateChanged(auth,async u=>{
if(!u)return location.href="login.html";
uid=u.uid;

const snap=await getDoc(doc(db,"users",uid));
baseUser=snap.data()||{};

staticWrap.innerHTML=`
<div class="block">
<label>Profile Photo</label>
<input type="file" id="photoInput" accept="image/*">
<img id="photoPreview"
src="${baseUser.profilePhoto||'https://cdn-icons-png.flaticon.com/512/149/149071.png'}"
style="margin-top:10px;width:100px;height:100px;border-radius:50%;object-fit:cover">
</div>

<div class="block">
<label>Full Name *</label>
<input id="fullName" value="${baseUser.fullName||""}">
</div>

<div class="block">
<label>Mobile *</label>
<input id="phone" value="${baseUser.phone||""}">
</div>

<div class="block">
<label>Email</label>
<input value="${u.email}" readonly>
</div>
`;

document.getElementById("photoInput").addEventListener("change",e=>{
const file=e.target.files[0];
if(!file)return;
const reader=new FileReader();
reader.onload=()=>photoPreview.src=reader.result;
reader.readAsDataURL(file);
});

const fs=await getDocs(collection(db,"profileFields"));
fs.forEach(d=>{
adminWrap.innerHTML+=`
<div class="block">
<label>${d.data().label||d.id}</label>
<input data-admin="${d.id}" value="${baseUser.adminFields?.[d.id]||""}">
</div>`;
});

adminValues=baseUser.adminFields||{};
userCustom=baseUser.userCustomFields||{};

Object.entries(userCustom).forEach(([k,v])=>drawUserCustom(k,v.value,v.showOnDashboard));
});

window.addUserCustom=()=>drawUserCustom();

function drawUserCustom(k="",v="",s=false){
userWrap.innerHTML+=`
<div class="block">
<input class="ckey" placeholder="Field name" value="${k}">
<input class="cval" placeholder="Value" value="${v}">
<div class="row">
<span><input type="checkbox" class="cshow" ${s?"checked":""}> Dashboard</span>
<button class="btn" onclick="this.closest('.block').remove()">Delete</button>
</div>
</div>`;
}

window.saveProfile=async()=>{
const fullName=document.getElementById("fullName").value.trim();
const phone=document.getElementById("phone").value.trim();
const photoInput=document.getElementById("photoInput");

if(fullName.length<3||!/^[0-9]{10}$/.test(phone)){
popup("error");
return;
}

adminValues={};
document.querySelectorAll("[data-admin]").forEach(i=>{
adminValues[i.dataset.admin]=i.value.trim();
});

userCustom={};
[...userWrap.children].forEach(b=>{
const k=b.querySelector(".ckey").value.trim();
if(k){
userCustom[k]={
value:b.querySelector(".cval").value,
showOnDashboard:b.querySelector(".cshow").checked
};
}
});

loader.style.display="flex";

let photoURL=baseUser.profilePhoto||"";

if(photoInput.files.length>0){
const file=photoInput.files[0];
const storageRef=ref(storage,"profilePhotos/"+uid+"/photo.jpg");
await uploadBytes(storageRef,file);
photoURL=await getDownloadURL(storageRef);
}

await setDoc(doc(db,"users",uid),{
fullName,
phone,
profilePhoto:photoURL,
adminFields:adminValues,
userCustomFields:userCustom,
updatedAt:new Date().toISOString()
},{merge:true});

loader.style.display="none";
popup("success");
};

window.exportPDF=()=>{
const { jsPDF }=window.jspdf;
const pdf=new jsPDF();
pdf.text("My Profile",105,15,{align:"center"});
pdf.text("Name: "+fullName.value,10,30);
pdf.text("Phone: "+phone.value,10,40);
pdf.text("Email: "+(auth.currentUser?.email||""),10,50);
pdf.save("my-profile.pdf");
};

window.exportExcel=()=>{
const rows=[
["Full Name",fullName.value],
["Phone",phone.value],
["Email",auth.currentUser?.email||""]
];
Object.entries(adminValues).forEach(([k,v])=>rows.push([k,v]));
Object.entries(userCustom).forEach(([k,v])=>rows.push([k,v.value]));
const ws=XLSX.utils.aoa_to_sheet(rows);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Profile");
XLSX.writeFile(wb,"my-profile.xlsx");
};
</script>
</body>
</html>
