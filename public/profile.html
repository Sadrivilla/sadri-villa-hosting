<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Profile | Sadri Villa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#eef6ff}

/* BUTTON */
.btn{
  background:linear-gradient(135deg,#38bdf8,#60a5fa);
  color:#fff;border:none;padding:10px 18px;
  border-radius:14px;font-weight:bold;cursor:pointer;
}
.btn:hover{transform:translateY(-2px)}

.btn-green{
  background:linear-gradient(135deg,#22c55e,#16a34a);
}

/* MODAL */
.profile-modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999;
}
.modal-card{
  background:#fff;
  width:95%;
  max-width:1000px;
  border-radius:26px;
  padding:28px;
  max-height:90vh;
  overflow-y:auto;
  box-shadow:0 25px 60px rgba(0,0,0,.3);
}

/* CLOSE */
.close-btn{
  float:right;
  font-size:22px;
  cursor:pointer;
}

/* GRID */
.section{margin-bottom:28px}
.section h3{color:#2563eb;margin-bottom:14px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
@media(max-width:768px){.grid{grid-template-columns:1fr}}

.block{
  background:#f8fbff;border:1px solid #c7d2fe;
  padding:14px;border-radius:14px;margin-bottom:10px
}
label{font-size:13px;font-weight:bold}
input{width:100%;margin-top:6px;padding:12px;border-radius:12px;border:1.5px solid #d1d5db}

/* PROFILE IMAGE */
.photo-section{text-align:center;margin-bottom:20px}
#photoPreview{
  width:80px;height:80px;border-radius:50%;
  object-fit:cover;border:3px solid #38bdf8;
  cursor:pointer;
  background:#e0f2fe
}

/* CUSTOM FIELD */
.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:8px;
}
.delete-btn{
  background:#ef4444;color:white;border:none;
  padding:6px 10px;border-radius:8px;cursor:pointer
}

/* LOADER */
.loader{
  position:fixed;inset:0;background:rgba(0,0,0,.4);
  display:none;align-items:center;justify-content:center;z-index:10000
}
.loader div{
  width:60px;height:60px;border:6px solid #e5e7eb;
  border-top:6px solid #38bdf8;border-radius:50%;
  animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}

/* POPUP */
.popup{
  position:fixed;bottom:30px;left:50%;
  transform:translateX(-50%);
  padding:14px 24px;border-radius:12px;
  color:#fff;font-weight:bold;display:none;
}
.success{background:#22c55e}
.error{background:#ef4444}
</style>
</head>

<body>

<div style="text-align:center;margin-top:50px">
  <img id="openProfileImage"
   src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png"
   style="width:90px;height:90px;border-radius:50%;border:4px solid #38bdf8;cursor:pointer;">
  <h2>My Profile</h2>
</div>

<!-- MODAL -->
<div class="profile-modal" id="profileModal">
  <div class="modal-card">

    <span class="close-btn" onclick="closeModal()">‚úñ</span>

    <button class="btn btn-green" onclick="location.href='dashboard.html'">‚Üê Back</button>

    <div class="photo-section">
      <img id="photoPreview"
       src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png">
      <br><br>
      <input type="file" id="photoInput" accept="image/*">
      <br><br>
      <button class="btn" onclick="savePhoto()">üíæ Save Profile Picture</button>
    </div>

    <div class="section">
      <h3>User Details</h3>
      <div class="grid" id="staticWrap"></div>
    </div>

    <div class="section">
      <h3>Admin Fields</h3>
      <div class="grid" id="adminWrap"></div>
    </div>

    <div class="section">
      <h3>Your Custom Fields</h3>
      <div id="userWrap"></div>
      <button class="btn" onclick="addUserCustom()">‚ûï Add Custom Field</button>
    </div>

    <br>
    <button class="btn" onclick="saveProfile()">üíæ Save Profile</button>

  </div>
</div>

<div class="loader" id="loader"><div></div></div>
<div class="popup success" id="successPopup">Profile updated successfully</div>
<div class="popup error" id="errorPopup">Something went wrong</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore,doc,getDoc,setDoc,collection,getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage,ref,uploadBytes,getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const app=initializeApp({
  apiKey:"AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain:"sadri-villa-14c06.firebaseapp.com",
  projectId:"sadri-villa-14c06",
  storageBucket:"sadri-villa-14c06.firebasestorage.app"
});

const auth=getAuth(app);
const db=getFirestore(app);
const storage=getStorage(app);

let uid,userCustom={},adminValues={};

const loader=document.getElementById("loader");

const showSuccess=()=>{successPopup.style.display="block";setTimeout(()=>successPopup.style.display="none",2000);}
const showError=()=>{errorPopup.style.display="block";setTimeout(()=>errorPopup.style.display="none",2000);}

/* OPEN MODAL */
document.getElementById("openProfileImage").onclick=()=>{
  document.getElementById("profileModal").style.display="flex";
}
window.closeModal=()=>{
  document.getElementById("profileModal").style.display="none";
}

/* PREVIEW */
photoInput.onchange=e=>{
  const file=e.target.files[0];
  if(file)photoPreview.src=URL.createObjectURL(file);
};

onAuthStateChanged(auth,async user=>{
  if(!user)return location.href="login.html";
  uid=user.uid;

  const snap=await getDoc(doc(db,"users",uid));
  const data=snap.data()||{};

  if(data.profilePhoto){
    photoPreview.src=data.profilePhoto;
    openProfileImage.src=data.profilePhoto;
  }

  staticWrap.innerHTML=`
    <div class="block"><label>Full Name</label>
      <input id="fullName" value="${data.fullName||""}">
    </div>
    <div class="block"><label>Mobile</label>
      <input id="phone" value="${data.phone||""}">
    </div>
  `;

  /* ADMIN FIELDS */
  const fs=await getDocs(collection(db,"profileFields"));
  adminValues=data.adminFields||{};
  fs.forEach(d=>{
    adminWrap.innerHTML+=`
      <div class="block">
        <label>${d.data().label||d.id}</label>
        <input data-admin="${d.id}" value="${adminValues[d.id]||""}">
      </div>
    `;
  });

  /* CUSTOM FIELDS */
  userCustom=data.userCustomFields||{};
  Object.entries(userCustom).forEach(([k,v])=>{
    drawUserCustom(k,v.value,v.showOnDashboard);
  });
});

/* ADD CUSTOM FIELD */
window.addUserCustom=()=>drawUserCustom();

function drawUserCustom(k="",v="",show=false){
  userWrap.innerHTML+=`
    <div class="block">
      <input class="ckey" placeholder="Field name" value="${k}">
      <input class="cval" placeholder="Answer" value="${v}">
      <div class="row">
        <label><input type="checkbox" class="cshow" ${show?"checked":""}> Show on Dashboard</label>
        <button class="delete-btn" onclick="this.closest('.block').remove()">Delete</button>
      </div>
    </div>
  `;
}

/* SAVE PHOTO */
window.savePhoto=async()=>{
  try{
    const file=photoInput.files[0];
    if(!file)return alert("Select image first");

    loader.style.display="flex";

    const storageRef=ref(storage,`profilePhotos/${uid}/profile.jpg`);
    await uploadBytes(storageRef,file);
    const url=await getDownloadURL(storageRef);

    await setDoc(doc(db,"users",uid),{profilePhoto:url},{merge:true});

    loader.style.display="none";
    showSuccess();
  }catch(e){loader.style.display="none";showError();}
};

/* SAVE PROFILE */
window.saveProfile=async()=>{
  try{
    const fullName=fullName.value.trim();
    const phone=phone.value.trim();

    adminValues={};
    document.querySelectorAll("[data-admin]").forEach(i=>{
      adminValues[i.dataset.admin]=i.value.trim();
    });

    userCustom={};
    [...userWrap.children].forEach(b=>{
      const k=b.querySelector(".ckey").value.trim();
      if(k){
        userCustom[k]={
          value:b.querySelector(".cval").value.trim(),
          showOnDashboard:b.querySelector(".cshow").checked
        };
      }
    });

    loader.style.display="flex";

    await setDoc(doc(db,"users",uid),{
      fullName,
      phone,
      adminFields:adminValues,
      userCustomFields:userCustom,
      updatedAt:new Date().toISOString()
    },{merge:true});

    loader.style.display="none";
    showSuccess();
  }catch(e){loader.style.display="none";showError();}
};
</script>

</body>
</html>
