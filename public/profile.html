<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Profile | Sadri Villa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Arial,sans-serif;
  background:#eef6ff;
}

/* ===== GLASSY LIGHT-BLUE BUTTON ===== */
.btn{
  background:linear-gradient(135deg,#38bdf8,#60a5fa);
  color:#fff;
  border:none;
  padding:10px 18px;
  border-radius:14px;
  font-weight:bold;
  cursor:pointer;
  transition:.25s;
  box-shadow:0 8px 20px rgba(56,189,248,.35);
}
.btn:hover{
  transform:translateY(-2px);
  box-shadow:0 12px 26px rgba(56,189,248,.5);
}
.btn.danger{
  background:linear-gradient(135deg,#f87171,#ef4444);
  box-shadow:0 8px 20px rgba(239,68,68,.35);
}

/* ===== TOP BAR ===== */
.topbar{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  padding:14px 20px;
  background:rgba(255,255,255,.65);
  backdrop-filter:blur(12px);
}

/* ===== LAYOUT ===== */
.wrap{
  max-width:1100px;
  margin:auto;
  padding:24px;
}
.card{
  background:#fff;
  border-radius:26px;
  padding:28px;
  box-shadow:0 20px 45px rgba(0,0,0,.12);
}
h2{text-align:center;margin:0 0 24px}
.section{margin-bottom:28px}
.section h3{color:#2563eb;margin-bottom:14px}

/* ===== GRID ===== */
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:18px;
}
@media(max-width:768px){.grid{grid-template-columns:1fr}}

/* ===== INPUTS ===== */
.block{
  background:#f8fbff;
  border:1px solid #c7d2fe;
  padding:14px;
  border-radius:14px;
}
label{font-size:13px;font-weight:bold}
label span{color:#dc2626}
input,select{
  width:100%;
  margin-top:6px;
  padding:12px;
  border-radius:12px;
  border:1.5px solid #d1d5db;
}
input[readonly]{background:#e5e7eb}

/* ===== CUSTOM ===== */
.row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-top:8px;
}

/* ===== ACTIONS ===== */
.actions{
  display:flex;
  gap:14px;
  flex-wrap:wrap;
}
.actions .btn{flex:1}

/* ===== LOADER ===== */
.loader{
  position:fixed;inset:0;
  background:rgba(0,0,0,.4);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999
}
.loader div{
  width:60px;height:60px;
  border:6px solid #e5e7eb;
  border-top:6px solid #38bdf8;
  border-radius:50%;
  animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== POPUP ===== */
.popup{
  position:fixed;inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  z-index:10000
}
.popup .box{
  padding:18px 34px;
  border-radius:20px;
  color:#fff;
  font-weight:bold
}
.success{background:#22c55e}
.error{background:#ef4444}
</style>
</head>

<body>

<!-- TOP BAR -->
<div class="topbar">
  <button class="btn" onclick="location.href='dashboard.html'">Dashboard</button>
  <button class="btn" onclick="location.href='profile.html'">Profile</button>
  <button class="btn" onclick="exportPDF()">üìÑ Export PDF</button>
  <button class="btn" onclick="exportExcel()">üìä Export Excel</button>
</div>

<div class="wrap">
<div class="card">

<h2>üë§ My Profile</h2>

<div class="section">
  <h3>User Details</h3>
  <div class="grid" id="staticWrap"></div>
</div>

<div class="section">
  <h3>Admin Fields</h3>
  <div class="grid" id="adminWrap"></div>
</div>

<div class="section">
  <h3>Your Custom Fields</h3>
  <div id="userWrap"></div>
  <button class="btn" onclick="addUserCustom()">‚ûï Add Custom Field</button>
</div>

<div class="actions">
  <button class="btn" onclick="saveProfile()">üíæ Save Profile</button>
</div>

</div>
</div>

<div class="loader" id="loader"><div></div></div>
<div class="popup" id="success"><div class="box success">‚úÖ Profile saved</div></div>
<div class="popup" id="error"><div class="box error">‚ùå Fill required fields</div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore,doc,getDoc,setDoc,collection,getDocs } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage,ref,uploadBytes,getDownloadURL } 
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const app=initializeApp({
  apiKey:"AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain:"sadri-villa-14c06.firebaseapp.com",
  projectId:"sadri-villa-14c06"
});

const auth=getAuth(app);
const db=getFirestore(app);
const storage=getStorage(app);

const staticWrap=document.getElementById("staticWrap");
const adminWrap=document.getElementById("adminWrap");
const userWrap=document.getElementById("userWrap");
const loader=document.getElementById("loader");

let uid,profileFields=[],adminValues={},userCustom={},baseUser={};

const popup=id=>{
  const p=document.getElementById(id);
  p.style.display="flex";
  setTimeout(()=>p.style.display="none",2000);
};

onAuthStateChanged(auth,async u=>{
  if(!u) return location.href="login.html";
  uid=u.uid;

  const snap=await getDoc(doc(db,"users",uid));
  baseUser=snap.data()||{};

  staticWrap.innerHTML=`
    <div class="block">
      <label>Profile Photo</label>
      <input type="file" id="photoInput" accept="image/*">
      <img id="photoPreview"
        src="${baseUser.profilePhoto||'https://cdn-icons-png.flaticon.com/512/149/149071.png'}"
        style="margin-top:10px;width:100px;height:100px;border-radius:50%;object-fit:cover">
    </div>

    <div class="block">
      <label>Full Name <span>*</span></label>
      <input id="fullName" value="${baseUser.fullName||""}">
    </div>

    <div class="block">
      <label>Mobile <span>*</span></label>
      <input id="phone" value="${baseUser.phone||""}">
    </div>

    <div class="block">
      <label>Email</label>
      <input value="${u.email}" readonly>
    </div>

    <div class="block">
      <label>Role</label>
      <input value="${baseUser.role||'User'}" readonly>
    </div>
  `;

  const photoInput=document.getElementById("photoInput");
  const photoPreview=document.getElementById("photoPreview");

  photoInput?.addEventListener("change", e=>{
    const file=e.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=()=>photoPreview.src=reader.result;
    reader.readAsDataURL(file);
  });

  const fs=await getDocs(collection(db,"profileFields"));
  fs.forEach(d=>profileFields.push({key:d.id,...d.data()}));

  adminValues=baseUser.adminFields||{};
  userCustom=baseUser.userCustomFields||{};

  profileFields.forEach(f=>{
    if(f.visible===false) return;
    adminWrap.innerHTML+=`
      <div class="block">
        <label>${f.label||f.key} ${f.required?'<span>*</span>':''}</label>
        <input data-admin="${f.key}" value="${adminValues[f.key]||""}">
      </div>
    `;
  });

  Object.entries(userCustom).forEach(([k,v])=>{
    drawUserCustom(k,v.value,v.showOnDashboard);
  });
});

window.addUserCustom=()=>drawUserCustom();

function drawUserCustom(k="",v="",s=false){
  userWrap.innerHTML+=`
    <div class="block">
      <input class="ckey" placeholder="Field name" value="${k}">
      <input class="cval" placeholder="Value" value="${v}">
      <div class="row">
        <span><input type="checkbox" class="cshow" ${s?"checked":""}> Dashboard</span>
        <button class="btn danger" onclick="this.closest('.block').remove()">üóë</button>
      </div>
    </div>
  `;
}

window.saveProfile=async()=>{
  const fullName=document.getElementById("fullName").value.trim();
  const phone=document.getElementById("phone").value.trim();
  const photoInput=document.getElementById("photoInput");

  if(fullName.length<3||!/^[0-9]{10}$/.test(phone)){
    popup("error");
    return;
  }

  adminValues={};
  document.querySelectorAll("[data-admin]").forEach(i=>{
    adminValues[i.dataset.admin]=i.value.trim();
  });

  userCustom={};
  [...userWrap.children].forEach(b=>{
    const k=b.querySelector(".ckey").value.trim();
    if(k){
      userCustom[k]={
        value:b.querySelector(".cval").value,
        showOnDashboard:b.querySelector(".cshow").checked
      };
    }
  });

  loader.style.display="flex";

  let photoURL=baseUser.profilePhoto||"";

  if(photoInput.files.length>0){
    const file=photoInput.files[0];
    const storageRef=ref(storage,"profilePhotos/"+uid);
    await uploadBytes(storageRef,file);
    photoURL=await getDownloadURL(storageRef);
  }

  await setDoc(doc(db,"users",uid),{
    fullName,
    phone,
    profilePhoto:photoURL,
    adminFields:adminValues,
    userCustomFields:userCustom,
    updatedAt:new Date().toISOString()
  },{merge:true});

  loader.style.display="none";
  popup("success");
};

window.exportPDF=()=>{
  const { jsPDF }=window.jspdf;
  const pdf=new jsPDF();
  const fullName=document.getElementById("fullName").value;
  const phone=document.getElementById("phone").value;
  const email=auth.currentUser?.email||"";

  let y=15;
  pdf.text("My Profile",105,y,{align:"center"});y+=10;
  pdf.text(`Name: ${fullName}`,10,y);y+=7;
  pdf.text(`Phone: ${phone}`,10,y);y+=7;
  pdf.text(`Email: ${email}`,10,y);

  pdf.save("my-profile.pdf");
};

window.exportExcel=()=>{
  const fullName=document.getElementById("fullName").value;
  const phone=document.getElementById("phone").value;
  const email=auth.currentUser?.email||"";

  const rows=[
    ["Full Name",fullName],
    ["Phone",phone],
    ["Email",email]
  ];

  Object.entries(adminValues).forEach(([k,v])=>rows.push([k,v]));
  Object.entries(userCustom).forEach(([k,v])=>rows.push([k,v.value]));

  const ws=XLSX.utils.aoa_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Profile");
  XLSX.writeFile(wb,"my-profile.xlsx");
};
</script>


</body>
</html>
