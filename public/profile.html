<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>My Profile | Sadri Villa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial;background:#eef6ff}

/* BUTTON */
.btn{
  background:linear-gradient(135deg,#38bdf8,#60a5fa);
  color:#fff;border:none;padding:10px 18px;
  border-radius:14px;font-weight:bold;cursor:pointer;
  transition:.25s;
}
.btn:hover{transform:translateY(-2px)}

/* LAYOUT */
.wrap{max-width:1100px;margin:auto;padding:24px}
.card{
  background:#fff;border-radius:26px;padding:28px;
  box-shadow:0 20px 45px rgba(0,0,0,.12);
}
h2{text-align:center;margin:0 0 24px}
.section{margin-bottom:28px}
.section h3{color:#2563eb;margin-bottom:14px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
@media(max-width:768px){.grid{grid-template-columns:1fr}}

.block{
  background:#f8fbff;border:1px solid #c7d2fe;
  padding:14px;border-radius:14px
}
label{font-size:13px;font-weight:bold}
label span{color:#dc2626}
input{width:100%;margin-top:6px;padding:12px;border-radius:12px;border:1.5px solid #d1d5db}
input[readonly]{background:#e5e7eb}

/* PROFILE PHOTO */
.photo-section{text-align:center;margin-bottom:30px}
#photoPreview{
  width:80px;height:80px;border-radius:50%;
  object-fit:cover;border:3px solid #38bdf8;
  display:block;margin:0 auto 12px;
  background:#e0f2fe
}

/* LOADER */
.loader{
  position:fixed;inset:0;background:rgba(0,0,0,.4);
  display:none;align-items:center;justify-content:center;z-index:9999
}
.loader div{
  width:60px;height:60px;border:6px solid #e5e7eb;
  border-top:6px solid #38bdf8;border-radius:50%;
  animation:spin 1s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>

<div class="wrap">
<div class="card">

<h2>ðŸ‘¤ My Profile</h2>

<!-- PROFILE PHOTO -->
<div class="photo-section">
  <img id="photoPreview"
   src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png">
  <input type="file" id="photoInput" accept="image/*">
  <br><br>
  <button class="btn" onclick="savePhoto()">ðŸ’¾ Save Profile Picture</button>
</div>

<div class="section">
  <h3>User Details</h3>
  <div class="grid" id="staticWrap"></div>
</div>

<div class="section">
  <h3>Admin Fields</h3>
  <div class="grid" id="adminWrap"></div>
</div>

<div class="section">
  <h3>Your Custom Fields</h3>
  <div id="userWrap"></div>
  <button class="btn" onclick="addUserCustom()">âž• Add Custom Field</button>
</div>

<br>
<button class="btn" onclick="saveProfile()">ðŸ’¾ Save Profile</button>

</div>
</div>

<div class="loader" id="loader"><div></div></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore,doc,getDoc,setDoc,collection,getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage,ref,uploadBytes,getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const app=initializeApp({
  apiKey:"AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain:"sadri-villa-14c06.firebaseapp.com",
  projectId:"sadri-villa-14c06",
  storageBucket:"sadri-villa-14c06.appspot.com"
});
const auth=getAuth(app);
const db=getFirestore(app);
const storage=getStorage(app);

let uid,adminValues={},userCustom={},baseUser={};

const staticWrap=document.getElementById("staticWrap");
const adminWrap=document.getElementById("adminWrap");
const userWrap=document.getElementById("userWrap");
const loader=document.getElementById("loader");

const photoInput=document.getElementById("photoInput");
const photoPreview=document.getElementById("photoPreview");

/* PREVIEW */
photoInput.onchange=e=>{
  const file=e.target.files[0];
  if(file){
    photoPreview.src=URL.createObjectURL(file);
  }
};

onAuthStateChanged(auth,async u=>{
  if(!u)return location.href="login.html";
  uid=u.uid;

  const snap=await getDoc(doc(db,"users",uid));
  baseUser=snap.data()||{};

  if(baseUser.profilePhoto)
    photoPreview.src=baseUser.profilePhoto;

  staticWrap.innerHTML=`
    <div class="block"><label>Full Name <span>*</span></label>
      <input id="fullName" value="${baseUser.fullName||""}">
    </div>
    <div class="block"><label>Mobile <span>*</span></label>
      <input id="phone" value="${baseUser.phone||""}">
    </div>
    <div class="block"><label>Email</label>
      <input value="${u.email}" readonly>
    </div>
  `;

});

/* SAVE PHOTO ONLY */
window.savePhoto=async()=>{
  const file=photoInput.files[0];
  if(!file)return alert("Select image first");

  loader.style.display="flex";

  const storageRef=ref(storage,`profilePhotos/${uid}/profile.jpg`);
  await uploadBytes(storageRef,file);

  const url=await getDownloadURL(storageRef);

  await setDoc(doc(db,"users",uid),{
    profilePhoto:url
  },{merge:true});

  loader.style.display="none";
  alert("Profile picture updated");

  // Dashboard auto updates because it uses onSnapshot
};

/* SAVE PROFILE (OLD LOGIC UNCHANGED) */
window.saveProfile=async()=>{
  const fullName=document.getElementById("fullName").value.trim();
  const phone=document.getElementById("phone").value.trim();

  if(fullName.length<3||!/^[0-9]{10}$/.test(phone)){
    alert("Fill required fields properly");
    return;
  }

  loader.style.display="flex";

  await setDoc(doc(db,"users",uid),{
    fullName,
    phone,
    updatedAt:new Date().toISOString()
  },{merge:true});

  loader.style.display="none";
  alert("Profile updated");
};
</script>

</body>
</html>
