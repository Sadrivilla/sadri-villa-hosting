<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin â€“ Slider Images | Sadri Villa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#eef2ff}
.navbar{padding:14px 24px;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.08)}
.container{max-width:1100px;margin:20px auto;background:#fff;padding:24px;border-radius:20px;box-shadow:0 20px 50px rgba(0,0,0,.12)}
.upload-box{border:2px dashed #cbd5e1;border-radius:18px;padding:24px;text-align:center}
.upload-box input{display:none}
.upload-box label{padding:12px 22px;background:#2563eb;color:#fff;border-radius:14px;cursor:pointer;font-weight:600}
.preview-grid{display:flex;flex-wrap:wrap;gap:15px;margin-top:20px}
.preview-item{width:180px;text-align:center}
.preview-item img{width:100%;height:120px;object-fit:cover;border-radius:12px}
.progress-bar{height:8px;background:#e5e7eb;border-radius:10px;margin-top:6px;overflow:hidden}
.progress-fill{height:100%;width:0%;background:#2563eb}
button{padding:6px 10px;border:none;border-radius:10px;cursor:pointer;background:#2563eb;color:#fff;font-size:12px}
.item{display:flex;align-items:center;gap:14px;padding:12px;border-radius:12px;margin-bottom:10px;background:#f8fafc}
.item.enabled{background:#dcfce7}
.item img{width:120px;height:70px;object-fit:cover;border-radius:10px}
.center-popup{
 position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.9);
 background:#fff;padding:24px 30px;border-radius:20px;
 box-shadow:0 20px 60px rgba(0,0,0,.25);
 text-align:center;font-weight:600;z-index:9999;
 opacity:0;transition:.3s
}
.center-popup.show{opacity:1;transform:translate(-50%,-50%) scale(1)}
.success{color:#16a34a}
.error{color:#dc2626}
</style>
</head>

<body>

<div class="navbar">
  <h3>ðŸ–¼ Slider Images â€“ Admin</h3>
</div>

<div class="container">

<div class="upload-box">
  <input type="file" id="fileInput" accept="image/*" multiple>
  <label for="fileInput">Select Multiple Images</label>

  <div id="previewGrid" class="preview-grid"></div>

  <br>
  <button id="uploadBtn" style="display:none;">Upload Images</button>
</div>


<h4 style="margin-top:30px">Existing Slider Images</h4>
<div id="sliderList"></div>

</div>

<div id="popup" class="center-popup"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

/* ðŸ”¥ FIREBASE CONFIG */
const app = initializeApp({
  apiKey: "AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain: "sadri-villa-14c06.firebaseapp.com",
  projectId: "sadri-villa-14c06",
  storageBucket: "sadri-villa-14c06.firebasestorage.app"
});

const auth=getAuth(app);
const db=getFirestore(app);
const storage=getStorage(app);

const fileInput=document.getElementById("fileInput");
const previewGrid=document.getElementById("previewGrid");
const sliderList=document.getElementById("sliderList");
const popup=document.getElementById("popup");

let sliderImages=[];
let selectedFiles=[];

/* POPUP */
function showPopup(msg,type="success"){
 popup.innerHTML=`<div class="${type}">${msg}</div>`;
 popup.classList.add("show");
 setTimeout(()=>popup.classList.remove("show"),2500);
}

/* ADMIN CHECK (NO INSTANT REDIRECT BUG) */
onAuthStateChanged(auth, async (user)=>{
 if(!user){
   showPopup("Login required","error");
   setTimeout(()=>location.href="login.html",1500);
   return;
 }

 try{
   const snap=await getDoc(doc(db,"users",user.uid));

   if(!snap.exists()){
     showPopup("User document not found","error");
     return;
   }

   if(snap.data().role!=="admin"){
     showPopup("Admin access only","error");
     return;
   }

   console.log("Admin verified âœ…");

 }catch(e){
   showPopup("Permission error","error");
   console.error(e);
 }
});

/* PREVIEW */
const uploadBtn = document.getElementById("uploadBtn");

fileInput.onchange = e => {
 selectedFiles = [...e.target.files];
 previewGrid.innerHTML = "";

 if(!selectedFiles.length){
   uploadBtn.style.display="none";
   return;
 }

 uploadBtn.style.display="inline-block";

 selectedFiles.forEach(file=>{
  const reader=new FileReader();
  reader.onload=ev=>{
   previewGrid.innerHTML+=`
   <div class="preview-item">
     <img src="${ev.target.result}">
     <div class="progress-bar">
       <div class="progress-fill"></div>
     </div>
   </div>`;
  };
  reader.readAsDataURL(file);
 });
};

/* Upload button click */
uploadBtn.onclick = () => {
  uploadAll();
};


/* LOAD */
onSnapshot(doc(db,"siteSettings","home"),snap=>{
 sliderImages=snap.data()?.sliderImages||[];
 render();
});

/* RENDER */
function render(){
 sliderList.innerHTML="";
 sliderImages.sort((a,b)=>a.order-b.order);

 sliderImages.forEach((img,i)=>{
  sliderList.innerHTML+=`
   <div class="item ${img.enabled!==false?"enabled":""}">
     <img src="${img.url}">
     <div style="flex:1">
       Order: ${img.order}<br>
       ${img.enabled===false?"Disabled":"Enabled"}
     </div>
     <button onclick="move(${i},-1)">â†‘</button>
     <button onclick="move(${i},1)">â†“</button>
     <button onclick="toggle(${i})">
       ${img.enabled===false?"Enable":"Disable"}
     </button>
     <button onclick="removeImg(${i})">Delete</button>
   </div>`;
 });
}

/* MULTI UPLOAD */
async function uploadAll(){
 if(!selectedFiles.length) return;

 let startOrder=sliderImages.length?
  Math.max(...sliderImages.map(i=>i.order))+1:1;

 for(let i=0;i<selectedFiles.length;i++){
  const file=selectedFiles[i];
  const fileRef=ref(storage,`images/site/slider/${Date.now()}-${file.name}`);
  const uploadTask=uploadBytesResumable(fileRef,file);

  const progressFill=previewGrid.children[i].querySelector(".progress-fill");

  await new Promise((resolve,reject)=>{
   uploadTask.on("state_changed",
    snap=>{
     const progress=(snap.bytesTransferred/snap.totalBytes)*100;
     progressFill.style.width=progress+"%";
    },
    err=>reject(err),
    async ()=>{
     const url=await getDownloadURL(uploadTask.snapshot.ref);
     sliderImages.push({
       url,
       order:startOrder++,
       enabled:true,
       createdAt:new Date()
     });
     resolve();
    });
  });
 }

 await updateDoc(doc(db,"siteSettings","home"),{sliderImages});
 previewGrid.innerHTML="";
 fileInput.value="";
 selectedFiles=[];
 showPopup("Images uploaded successfully","success");
}

/* MOVE */
window.move=async(i,dir)=>{
 const j=i+dir;
 if(j<0||j>=sliderImages.length) return;
 [sliderImages[i].order,sliderImages[j].order]=
 [sliderImages[j].order,sliderImages[i].order];
 await updateDoc(doc(db,"siteSettings","home"),{sliderImages});
 showPopup("Order updated","success");
};

/* TOGGLE */
window.toggle=async(i)=>{
 sliderImages[i].enabled=!sliderImages[i].enabled;
 await updateDoc(doc(db,"siteSettings","home"),{sliderImages});
 showPopup("Status updated","success");
};

/* DELETE */
window.removeImg=async(i)=>{
 if(!confirm("Delete this image?")) return;
 const url=sliderImages[i].url;
 sliderImages.splice(i,1);
 await updateDoc(doc(db,"siteSettings","home"),{sliderImages});
 try{
  const path=decodeURIComponent(url.split("/o/")[1].split("?")[0]);
  await deleteObject(ref(storage,path));
 }catch{}
 showPopup("Image deleted","error");
};
</script>

</body>
</html>
