<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin â€“ Slider Images | Sadri Villa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#eef2ff}
.navbar{padding:14px 24px;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.08)}
.container{max-width:1100px;margin:20px auto;background:#fff;padding:24px;border-radius:20px;box-shadow:0 20px 50px rgba(0,0,0,.12)}
.upload-box{border:2px dashed #cbd5e1;border-radius:18px;padding:24px;text-align:center}
.upload-box input{display:none}
.upload-box label{padding:12px 22px;background:#2563eb;color:#fff;border-radius:14px;cursor:pointer;font-weight:600}
.preview-grid{display:flex;flex-wrap:wrap;gap:15px;margin-top:20px}
.preview-item{width:180px;text-align:center}
.preview-item img{width:100%;height:120px;object-fit:cover;border-radius:12px}
.progress-bar{height:8px;background:#e5e7eb;border-radius:10px;margin-top:6px;overflow:hidden}
.progress-fill{height:100%;width:0%;background:#2563eb}
button{padding:6px 10px;border:none;border-radius:10px;cursor:pointer;background:#2563eb;color:#fff;font-size:12px}
.item{display:flex;align-items:center;gap:14px;padding:12px;border-radius:12px;margin-bottom:10px;background:#f8fafc}
.item.enabled{background:#dcfce7}
.item img{width:120px;height:70px;object-fit:cover;border-radius:10px}
.center-popup{
 position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(.9);
 background:#fff;padding:24px 30px;border-radius:20px;
 box-shadow:0 20px 60px rgba(0,0,0,.25);
 text-align:center;font-weight:600;z-index:9999;
 opacity:0;transition:.3s
}
.center-popup.show{opacity:1;transform:translate(-50%,-50%) scale(1)}
.success{color:#16a34a}
.error{color:#dc2626}
</style>
</head>

<body>

<div class="navbar">
  <h3>ðŸ–¼ Slider Images â€“ Admin</h3>
</div>

<div class="container">

<div class="upload-box">
  <input type="file" id="fileInput" accept="image/*" multiple hidden>
  <label for="fileInput">Select Images</label>
  <div id="previewGrid" class="preview-grid"></div>
  <br>
  <button id="uploadBtn" style="display:none;">Upload Images</button>
</div>

<h4 style="margin-top:30px">Existing Slider Images</h4>
<div id="sliderList"></div>

</div>

<div id="popup" class="center-popup"></div>

<!-- âœ… THIS WAS MISSING -->
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, doc, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

/* FIREBASE CONFIG */
const app = initializeApp({
  apiKey: "AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain: "sadri-villa-14c06.firebaseapp.com",
  projectId: "sadri-villa-14c06",
  storageBucket: "sadri-villa-14c06.firebasestorage.app"
});

const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const fileInput = document.getElementById("fileInput");
const previewGrid = document.getElementById("previewGrid");
const uploadBtn = document.getElementById("uploadBtn");
const sliderList = document.getElementById("sliderList");
const popup = document.getElementById("popup");

let sliderImages = [];
let selectedFiles = [];

/* POPUP */
function showPopup(msg, type = "success") {
  popup.innerHTML = `<div class="${type}">${msg}</div>`;
  popup.classList.add("show");
  setTimeout(() => popup.classList.remove("show"), 2500);
}

/* ADMIN CHECK */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = "login.html";
    return;
  }

  const snap = await getDoc(doc(db, "users", user.uid));
  if (!snap.exists() || snap.data().role !== "admin") {
    location.href = "dashboard.html";
  }
});

/* FILE SELECT */
fileInput.addEventListener("change", e => {
  selectedFiles = [...e.target.files];
  previewGrid.innerHTML = "";
  uploadBtn.style.display = selectedFiles.length ? "inline-block" : "none";

  selectedFiles.forEach(file => {
    const reader = new FileReader();
    reader.onload = ev => {
      previewGrid.innerHTML += `
        <div class="preview-item">
          <img src="${ev.target.result}">
          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>
        </div>`;
    };
    reader.readAsDataURL(file);
  });
});

/* LOAD SLIDERS */
onSnapshot(doc(db, "siteSettings", "home"), snap => {
  sliderImages = snap.data()?.sliderImages || [];
  render();
});

/* RENDER */
function render() {
  sliderList.innerHTML = "";
  sliderImages.sort((a, b) => a.order - b.order);

  sliderImages.forEach((img, i) => {

    const fileName = decodeURIComponent(
      img.url.split("/o/")[1].split("?")[0]
    ).split("/").pop();

    sliderList.innerHTML += `
      <div class="item ${img.enabled !== false ? "enabled" : ""}">
        <img src="${img.url}">
        <div style="flex:1">
          <div style="font-size:13px;font-weight:600;">
            ${fileName}
          </div>
          <small>Order: ${img.order}</small><br>
          <small>${img.enabled ? "Enabled" : "Disabled"}</small>
        </div>
        <button onclick="move(${i},-1)">â†‘</button>
        <button onclick="move(${i},1)">â†“</button>
        <button onclick="toggle(${i})">
          ${img.enabled ? "Disable" : "Enable"}
        </button>
        <button onclick="removeImg(${i})">Delete</button>
      </div>`;
  });
}

/* UPLOAD */
uploadBtn.addEventListener("click", async () => {
  if (!selectedFiles.length) return;

  let startOrder = sliderImages.length
    ? Math.max(...sliderImages.map(i => i.order)) + 1
    : 1;

  for (let i = 0; i < selectedFiles.length; i++) {
    const file = selectedFiles[i];
    const fileRef = ref(storage, `images/site/slider/${Date.now()}-${file.name}`);
    const uploadTask = uploadBytesResumable(fileRef, file);
    const progressFill = previewGrid.children[i].querySelector(".progress-fill");

    await new Promise((resolve, reject) => {
      uploadTask.on("state_changed",
        snap => {
          progressFill.style.width =
            (snap.bytesTransferred / snap.totalBytes) * 100 + "%";
        },
        reject,
        async () => {
          const url = await getDownloadURL(uploadTask.snapshot.ref);
          sliderImages.push({
            url,
            order: startOrder++,
            enabled: true
          });
          resolve();
        });
    });
  }

  await updateDoc(doc(db, "siteSettings", "home"), { sliderImages });

  selectedFiles = [];
  previewGrid.innerHTML = "";
  uploadBtn.style.display = "none";
  showPopup("Images uploaded successfully");
});

/* MOVE */
window.move = async (i, dir) => {
  const j = i + dir;
  if (j < 0 || j >= sliderImages.length) return;

  [sliderImages[i].order, sliderImages[j].order] =
  [sliderImages[j].order, sliderImages[i].order];

  await updateDoc(doc(db, "siteSettings", "home"), { sliderImages });
};

/* TOGGLE */
window.toggle = async (i) => {
  sliderImages[i].enabled = !sliderImages[i].enabled;
  await updateDoc(doc(db, "siteSettings", "home"), { sliderImages });
};

/* DELETE */
window.removeImg = async (i) => {
  if (!confirm("Delete this image?")) return;

  const url = sliderImages[i].url;
  sliderImages.splice(i, 1);
  await updateDoc(doc(db, "siteSettings", "home"), { sliderImages });

  const path = decodeURIComponent(url.split("/o/")[1].split("?")[0]);
  await deleteObject(ref(storage, path));
};

</script>
</body>
</html>
