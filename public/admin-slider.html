<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin ‚Äì Slider Images | Sadri Villa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- CROP LIB -->
<link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.css">

<style>
body{margin:0;font-family:Arial;background:#eef2ff}

/* NAV */
.navbar{
  padding:14px 24px;background:#eaf2ff;
  display:flex;justify-content:space-between;align-items:center;
  box-shadow:0 4px 12px rgba(0,0,0,.08)
}

/* CONTAINER */
.container{
  max-width:1000px;margin:30px auto;
  background:#fff;border-radius:18px;
  padding:24px;box-shadow:0 20px 50px rgba(0,0,0,.12)
}

/* UPLOAD */
.upload-box{
  border:2px dashed #94a3b8;border-radius:16px;
  padding:24px;text-align:center
}
.upload-box input{display:none}
.upload-box label{
  padding:12px 20px;background:#2563eb;color:#fff;
  border-radius:12px;cursor:pointer;font-weight:600
}
.preview{display:none;margin-top:16px}
.preview img{max-width:100%;max-height:300px;border-radius:14px}

/* LIST */
.item{
  display:flex;align-items:center;gap:12px;
  padding:12px;border-bottom:1px solid #e5e7eb;
  cursor:grab;background:#fff
}
.item.dragging{opacity:.4}
.item img{
  width:120px;height:70px;
  object-fit:cover;border-radius:10px
}
.item small{color:#475569}

/* BUTTONS */
button{
  padding:8px 14px;border:none;border-radius:10px;
  cursor:pointer;font-weight:600
}
.primary{background:#2563eb;color:#fff}
.danger{background:#dc2626;color:#fff}
.gray{background:#64748b;color:#fff}
.rotate{background:#e5e7eb}

/* MODAL */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.45);
  display:none;align-items:center;justify-content:center;
  z-index:9999
}
.modal-box{
  background:#fff;padding:24px;border-radius:18px;
  width:360px;text-align:center;
  box-shadow:0 25px 60px rgba(0,0,0,.3)
}
.modal-actions{
  display:flex;gap:12px;justify-content:center;margin-top:18px
}

/* TOAST */
.toast{
  position:fixed;right:20px;bottom:20px;
  padding:14px 18px;border-radius:14px;
  color:#fff;font-weight:600;
  box-shadow:0 15px 35px rgba(0,0,0,.25);
  opacity:0;transform:translateY(20px);
  transition:.35s;z-index:99999
}
.toast.show{opacity:1;transform:translateY(0)}
.toast.success{background:#16a34a}
.toast.error{background:#dc2626}
.toast.info{background:#2563eb}
</style>
</head>

<body>

<div class="navbar">
  <h3>üñº Slider Images ‚Äì Admin</h3>
  <button onclick="location.href='admin-dashboard.html'">‚Üê Back</button>
</div>

<div class="container">

  <!-- UPLOAD -->
  <div class="upload-box">
    <input type="file" id="fileInput" accept="image/*">
    <label for="fileInput">Select Slider Image</label>

    <div class="preview" id="previewBox">
      <img id="previewImg">
      <br><br>
      <button class="primary" onclick="upload()">Crop & Upload</button>
    </div>
  </div>

  <h4 style="margin-top:30px">Existing Slider Images</h4>
  <div id="sliderList"></div>

</div>

<!-- DELETE MODAL -->
<div class="modal" id="deleteModal">
  <div class="modal-box">
    <h4>Delete Image?</h4>
    <p>This action cannot be undone.</p>
    <div class="modal-actions">
      <button onclick="closeDelete()">Cancel</button>
      <button class="danger" onclick="confirmDelete()">Delete</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script src="https://unpkg.com/cropperjs@1.6.1/dist/cropper.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore,doc,onSnapshot,updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage,ref,uploadBytes,getDownloadURL,deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

/* FIREBASE */
const app=initializeApp({
  apiKey:"AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain:"sadri-villa-14c06.firebaseapp.com",
  projectId:"sadri-villa-14c06",
  storageBucket:"sadri-villa-14c06.firebasestorage.app"
});
const auth=getAuth(app);
const db=getFirestore(app);
const storage=getStorage(app);

/* DOM */
const fileInput=document.getElementById("fileInput");
const previewBox=document.getElementById("previewBox");
const previewImg=document.getElementById("previewImg");
const sliderList=document.getElementById("sliderList");
const toast=document.getElementById("toast");

let cropper=null;
let sliderImages=[];
let deleteUrl=null;

/* TOAST */
const showToast=(m,t="info")=>{
  toast.textContent=m;
  toast.className=`toast ${t} show`;
  setTimeout(()=>toast.classList.remove("show"),2500);
};

/* AUTH */
onAuthStateChanged(auth,async u=>{
  if(!u) location.href="login.html";
  const t=await u.getIdTokenResult(true);
  if(!t.claims.admin){
    alert("Admin only");
    location.href="dashboard.html";
  }
});

/* PREVIEW + CROP */
fileInput.onchange=e=>{
  const f=e.target.files[0];
  if(!f) return;
  previewImg.src=URL.createObjectURL(f);
  previewBox.style.display="block";
  cropper?.destroy();
  cropper=new Cropper(previewImg,{
    aspectRatio:16/9,
    viewMode:1
  });
};

/* LOAD */
onSnapshot(doc(db,"siteSettings","home"),snap=>{
  sliderImages=snap.data()?.sliderImages||[];
  render();
});

/* RENDER + DRAG */
function render(){
  sliderList.innerHTML="";
  sliderImages.sort((a,b)=>a.order-b.order).forEach((img,i)=>{
    const d=document.createElement("div");
    d.className="item";
    d.draggable=true;
    d.dataset.i=i;
    d.innerHTML=`
      <img src="${img.url}" style="transform:rotate(${img.rotation||0}deg)">
      <div style="flex:1">
        <small>Order: ${img.order}</small><br>
        <small>Status: ${img.enabled===false?"Disabled":"Enabled"}</small>
      </div>
      <button class="rotate" onclick="rotate(${i},-90)">‚ü≤</button>
      <button class="rotate" onclick="rotate(${i},90)">‚ü≥</button>
      <button class="gray" onclick="toggle(${i})">${img.enabled===false?"Enable":"Disable"}</button>
      <button class="danger" onclick="openDelete('${img.url}')">Delete</button>
    `;
    sliderList.appendChild(d);
  });
  dragInit();
}

/* DRAG ORDER */
function dragInit(){
  let drag;
  document.querySelectorAll(".item").forEach(i=>{
    i.ondragstart=()=>{drag=i;i.classList.add("dragging")};
    i.ondragend=()=>i.classList.remove("dragging");
    i.ondragover=e=>e.preventDefault();
    i.ondrop=async()=>{
      const a=+drag.dataset.i,b=+i.dataset.i;
      [sliderImages[a],sliderImages[b]]=[sliderImages[b],sliderImages[a]];
      sliderImages.forEach((x,j)=>x.order=j+1);
      await updateDoc(doc(db,"siteSettings","home"),{sliderImages});
      showToast("Order updated","info");
    };
  });
}

/* UPLOAD */
window.upload=async()=>{
  const blob=await new Promise(r=>cropper.getCroppedCanvas().toBlob(r));
  const refPath=ref(storage,`images/site/slider/${Date.now()}.jpg`);
  await uploadBytes(refPath,blob);
  const url=await getDownloadURL(refPath);

  sliderImages.push({
    url,
    order:sliderImages.length+1,
    enabled:true,
    rotation:0,
    createdAt:new Date()
  });

  await updateDoc(doc(db,"siteSettings","home"),{sliderImages});
  previewBox.style.display="none";
  showToast("Image uploaded","success");
};

/* ROTATE */
window.rotate=async(i,d)=>{
  sliderImages[i].rotation=(sliderImages[i].rotation+d+360)%360;
  await updateDoc(doc(db,"siteSettings","home"),{sliderImages});
};

/* TOGGLE */
window.toggle=async(i)=>{
  sliderImages[i].enabled=!sliderImages[i].enabled;
  await updateDoc(doc(db,"siteSettings","home"),{sliderImages});
};

/* DELETE */
window.openDelete=u=>{
  deleteUrl=u;
  document.getElementById("deleteModal").style.display="flex";
};
window.closeDelete=()=>{
  deleteUrl=null;
  document.getElementById("deleteModal").style.display="none";
};
window.confirmDelete=async()=>{
  sliderImages=sliderImages.filter(i=>i.url!==deleteUrl);
  await updateDoc(doc(db,"siteSettings","home"),{sliderImages});
  try{
    const p=decodeURIComponent(deleteUrl.split("/o/")[1].split("?")[0]);
    await deleteObject(ref(storage,p));
  }catch{}
  closeDelete();
  showToast("Image deleted","error");
};
</script>
</body>
</html>
