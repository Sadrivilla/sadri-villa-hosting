<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore,collection,getDocs,doc,getDoc,updateDoc,deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";

/* ðŸ”¥ FIREBASE INIT */
const app = initializeApp({
  apiKey:"AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain:"sadri-villa-14c06.firebaseapp.com",
  projectId:"sadri-villa-14c06"
});

const auth = getAuth(app);
const db = getFirestore(app);

let users=[];

/* ðŸ”” UI HELPERS */
const toast=(msg)=>{
  toastMsg.innerText=msg;
  toast.style.display="flex";
  setTimeout(()=>toast.style.display="none",2000);
};
const spinner=s=>spinnerEl.style.display=s?"flex":"none";
const spinnerEl=document.getElementById("spinner");

/* ðŸ” ADMIN GUARD */
onAuthStateChanged(auth, async user=>{
  if(!user) return location.href="login.html";
  const snap=await getDoc(doc(db,"users",user.uid));
  if(!snap.exists() || snap.data().role!=="admin"){
    alert("Access denied");
    return location.href="dashboard.html";
  }
  load();
});

/* âœ… NORMALIZER (IMPORTANT) */
function normalizeUser(u){
  return {
    uid: u.uid,
    name: u.Name || u.adminFields?.Name || u.fullName || "-",
    email:
      u.email ||
      u.adminFields?.Email ||
      u.adminFields?.email ||
      "-",
    phone:
      u.phone ||
      u.adminFields?.["Mobile Number"] ||
      u.adminFields?.Phone ||
      "-",
    role: u.role || "user",
    isApproved: !!u.isApproved,
    createdAt: u.createdAt || "",
    lastLogin: u.lastLogin || ""
  };
}

/* ðŸ“¥ LOAD USERS */
async function load(){
  spinner(true);
  users=[];
  (await getDocs(collection(db,"users")))
    .forEach(d=>users.push(normalizeUser({uid:d.id,...d.data()})));
  render();
  spinner(false);
}

/* ðŸ–¥ï¸ RENDER */
window.render=()=>{
  tbody.innerHTML="";
  const status=statusFilter.value;
  const role=roleFilter.value;
  const q=search.value.toLowerCase();

  users.filter(u=>{
    if(status==="approved" && !u.isApproved) return false;
    if(status==="pending" && u.isApproved) return false;
    if(role!=="all" && u.role!==role) return false;

    return (
      u.name.toLowerCase().includes(q) ||
      u.email.toLowerCase().includes(q) ||
      u.phone.toLowerCase().includes(q)
    );
  }).forEach(u=>{
    const created=u.createdAt?new Date(u.createdAt).toLocaleDateString("en-IN"):"-";
    const lastLogin=u.lastLogin?new Date(u.lastLogin).toLocaleString("en-IN"):"Never";

    tbody.innerHTML+=`
    <tr>
      <td><input type="checkbox" class="sel" value="${u.uid}"></td>
      <td>${u.name}</td>
      <td>${u.email}</td>
      <td>${u.phone}</td>
      <td>${u.role}</td>
      <td>${created}</td>
      <td>${lastLogin}</td>
      <td>
        <span class="badge ${u.isApproved?"green":"yellow"}">
          ${u.isApproved?"Approved":"Pending"}
        </span>
      </td>
      <td>
        <button onclick="toggle('${u.uid}',${u.isApproved})">
          ${u.isApproved?"Unapprove":"Approve"}
        </button>
      </td>
    </tr>`;
  });
};

/* âœ… ACTIONS */
window.toggleAll=cb=>document.querySelectorAll(".sel").forEach(c=>c.checked=cb.checked);
const selected=()=>[...document.querySelectorAll(".sel:checked")].map(x=>x.value);

window.toggle=async(id,v)=>{
  await updateDoc(doc(db,"users",id),{isApproved:!v});
  load();
};
window.bulkApprove=async()=>{
  for(const id of selected()) await updateDoc(doc(db,"users",id),{isApproved:true});
  toast("Approved");
  load();
};
window.bulkUnapprove=async()=>{
  for(const id of selected()) await updateDoc(doc(db,"users",id),{isApproved:false});
  toast("Unapproved");
  load();
};
window.bulkDelete=async()=>{
  for(const id of selected()) await deleteDoc(doc(db,"users",id));
  toast("Deleted");
  load();
};

/* ðŸ“¤ EXPORT */
window.exportXLSX=()=>{
  const rows=users.map(u=>({
    Name:u.name,
    Email:u.email,
    Phone:u.phone,
    Role:u.role,
    Status:u.isApproved?"Approved":"Pending",
    Created:u.createdAt,
    LastLogin:u.lastLogin||"Never"
  }));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(rows),"Users");
  XLSX.writeFile(wb,"users.xlsx");
};
</script>
