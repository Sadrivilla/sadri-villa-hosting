<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel | Sadri Villa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#eef2ff}

/* NAVBAR SAME AS INDEX */
.navbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 24px;background:#eaf2ff;
  box-shadow:0 4px 12px rgba(0,0,0,.08)
}
.nav-left{display:flex;align-items:center;gap:10px}
.nav-left img{height:40px}

/* CONTROLS */
.container{padding:20px}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px}
.controls select,.controls input{
  padding:8px 12px;border-radius:10px;border:1px solid #c7d2fe
}
.controls button{
  padding:8px 14px;border-radius:10px;border:none;
  color:#fff;cursor:pointer;font-weight:600
}
.success{background:#16a34a}
.secondary{background:#64748b}
.danger{background:#dc2626}
.export{background:#2563eb}

/* TABLE */
table{
  width:100%;border-collapse:collapse;background:#fff;
  border-radius:18px;overflow:hidden;
  box-shadow:0 18px 40px rgba(0,0,0,.1)
}
th,td{padding:10px;border-bottom:1px solid #e5e7eb;font-size:14px}
th{background:#f8fafc;text-align:left}

.badge{
  padding:4px 10px;border-radius:999px;
  color:#fff;font-size:12px
}
.green{background:#16a34a}
.yellow{background:#f59e0b}

/* MODAL */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.5);
  backdrop-filter:blur(6px);
  display:flex;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;transition:.3s;z-index:9999;
}
.modal-overlay.active{opacity:1;pointer-events:auto}
.modal-box{
  background:#fff;padding:25px;border-radius:18px;
  width:320px;text-align:center
}
.modal-buttons{margin-top:20px;display:flex;gap:15px;justify-content:center}
.modal-buttons button{
  padding:8px 16px;border:none;border-radius:999px;
  cursor:pointer;font-weight:600
}
.btn-cancel{background:#64748b;color:#fff}
.btn-confirm{background:#2563eb;color:#fff}

/* LOADER */
.loader{
  position:fixed;inset:0;background:rgba(255,255,255,.6);
  display:flex;align-items:center;justify-content:center;
  font-size:20px;font-weight:700;z-index:9998;
  display:none
}

/* TOAST */
.toast{
  position:fixed;bottom:30px;right:30px;
  padding:14px 20px;border-radius:12px;
  color:#fff;font-weight:600;
  opacity:0;transform:translateY(20px);
  transition:.3s;z-index:9999
}
.toast.show{opacity:1;transform:translateY(0)}
.toast.success{background:#16a34a}
.toast.error{background:#dc2626}
</style>
</head>

<body>

<!-- NAVBAR -->
<div class="navbar">
  <div class="nav-left">
    <img id="siteLogo">
    <h3>Sadri Villa â€“ Admin</h3>
  </div>
</div>

<div class="container">

<div class="controls">
  <select id="statusFilter" onchange="render()">
    <option value="all">All Users</option>
    <option value="approved">Approved</option>
    <option value="pending">Pending</option>
    <option value="admin">Admins Only</option>
    <option value="user">Users Only</option>
  </select>

  <input id="search" placeholder="Search..." oninput="render()">

  <button class="success" onclick="confirmBulk('approve')">Approve</button>
  <button class="secondary" onclick="confirmBulk('unapprove')">Unapprove</button>
  <button class="danger" onclick="confirmBulk('delete')">Delete</button>
  <button class="export" onclick="exportXLSX()">Export XLSX</button>
</div>

<table>
<thead>
<tr>
  <th><input type="checkbox" onclick="toggleAll(this)"></th>
  <th>#</th>
  <th>Name</th>
  <th>Email</th>
  <th>Role</th>
  <th>Created</th>
  <th>Status</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<div class="loader" id="loader">Loading...</div>

<div class="modal-overlay" id="modal">
  <div class="modal-box">
    <h3 id="modalText"></h3>
    <div class="modal-buttons">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-confirm" onclick="confirmAction()">Confirm</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,collection,onSnapshot,
  doc,getDoc,updateDoc,deleteDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";

const app=initializeApp({
  apiKey:"AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain:"sadri-villa-14c06.firebaseapp.com",
  projectId:"sadri-villa-14c06"
});

const auth=getAuth();
const db=getFirestore();

let users=[];
let pendingAction=null;

/* NAVBAR REALTIME LOGO */
onSnapshot(doc(db,"siteSettings","home"),snap=>{
  if(!snap.exists())return;
  const d=snap.data();
  if(d.logo?.url)
    document.getElementById("siteLogo").src=d.logo.url+"?v="+Date.now();
});

/* AUTH CHECK */
onAuthStateChanged(auth,async user=>{
  if(!user){location.href="login.html";return;}
  const snap=await getDoc(doc(db,"users",user.uid));
  if(!snap.exists()||snap.data().role!=="admin"){
    location.href="dashboard.html";return;
  }
});

/* REALTIME USERS */
onSnapshot(collection(db,"users"),snap=>{
  users=[];
  snap.forEach(d=>users.push({uid:d.id,...d.data()}));
  users.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
  render();
});

function formatDate(v){
  if(!v)return "-";
  if(v.seconds)return new Date(v.seconds*1000).toLocaleDateString("en-IN");
  return "-";
}

/* RENDER */
window.render=()=>{
  const tbody=document.getElementById("tbody");
  const q=document.getElementById("search").value.toLowerCase();
  const filter=document.getElementById("statusFilter").value;
  tbody.innerHTML="";

  let filtered=users.filter(u=>{
    if(filter==="admin"&&u.role!=="admin")return false;
    if(filter==="user"&&u.role==="admin")return false;
    if(filter==="approved"&&!u.approved)return false;
    if(filter==="pending"&&u.approved)return false;
    return (u.fullName||"").toLowerCase().includes(q)
        || (u.email||"").toLowerCase().includes(q);
  });

  filtered.forEach((u,i)=>{
    tbody.innerHTML+=`
    <tr>
      <td><input type="checkbox" class="sel" value="${u.uid}"></td>
      <td>${i+1}</td>
      <td>${u.fullName||"-"}</td>
      <td>${u.email||"-"}</td>
      <td>${u.role||"user"}</td>
      <td>${formatDate(u.createdAt)}</td>
      <td>
        <span class="badge ${u.approved?"green":"yellow"}">
          ${u.approved?"Approved":"Pending"}
        </span>
      </td>
      <td>
        <button onclick="confirmSingle('${u.uid}',${u.approved})">
          ${u.approved?"Unapprove":"Approve"}
        </button>
      </td>
    </tr>`;
  });
};

/* LOADER */
function showLoader(){document.getElementById("loader").style.display="flex";}
function hideLoader(){document.getElementById("loader").style.display="none";}

/* TOAST */
function showToast(msg,type="success"){
  const t=document.getElementById("toast");
  t.innerText=msg;
  t.className="toast "+type+" show";
  setTimeout(()=>t.classList.remove("show"),3000);
}

/* CONFIRMATIONS */
window.confirmSingle=(id,isApproved)=>{
  pendingAction={type:"single",id,isApproved};
  document.getElementById("modalText").innerText=
    isApproved?"Unapprove this user?":"Approve this user?";
  document.getElementById("modal").classList.add("active");
};

window.confirmBulk=(action)=>{
  const ids=[...document.querySelectorAll(".sel:checked")].map(x=>x.value);
  if(ids.length===0){showToast("Select users first","error");return;}
  pendingAction={type:"bulk",action,ids};
  document.getElementById("modalText").innerText=
    `Confirm ${action.toUpperCase()} for selected users?`;
  document.getElementById("modal").classList.add("active");
};

window.closeModal=()=>{
  pendingAction=null;
  document.getElementById("modal").classList.remove("active");
};

window.confirmAction=async()=>{
  showLoader();
  try{
    if(pendingAction.type==="single"){
      await updateDoc(doc(db,"users",pendingAction.id),
        {approved:!pendingAction.isApproved});
    }else{
      for(const id of pendingAction.ids){
        if(pendingAction.action==="approve")
          await updateDoc(doc(db,"users",id),{approved:true});
        if(pendingAction.action==="unapprove")
          await updateDoc(doc(db,"users",id),{approved:false});
        if(pendingAction.action==="delete")
          await deleteDoc(doc(db,"users",id));
      }
    }
    showToast("Action completed successfully");
  }catch(e){
    showToast("Something went wrong","error");
  }
  hideLoader();
  closeModal();
};

/* EXPORT */
window.exportXLSX=()=>{
  const rows=users.map(u=>({
    Name:u.fullName||"",
    Email:u.email||"",
    Role:u.role||"",
    Approved:u.approved?"Yes":"No",
    Created:formatDate(u.createdAt)
  }));
  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Users");
  XLSX.writeFile(wb,"users_export.xlsx");
};
</script>

</body>
</html>
