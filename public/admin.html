<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel | Sadri Villa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:Arial;background:#eef2ff}

/* ===== NAVBAR SAME AS INDEX (NO BUTTONS) ===== */
.navbar{
  position:fixed;
  top:0;left:0;right:0;
  height:50px;
  display:flex;
  align-items:center;
  background:rgba(255,255,255,0.75);
  backdrop-filter:blur(2px);
  border-bottom:1px solid rgba(0,0,0,.08);
  z-index:1000;
}
.brand{
  height:50px;
  display:flex;
  align-items:center;
  padding-left:10px;
}
.brand img{
  height:50px;
  object-fit:contain;
}

/* ===== ADMIN TOP BUTTONS ===== */
.admin-topbar{
  margin-top:50px;
  display:flex;
  gap:12px;
  padding:15px 20px;
  background:linear-gradient(180deg,#eef6ff,#f8fbff);
  overflow-x:auto;
}
.admin-btn{
  padding:10px 18px;
  border:none;
  border-radius:999px;
  cursor:pointer;
  font-weight:600;
  color:#fff;
  background:linear-gradient(135deg,#4facfe,#38bdf8);
}

/* ===== CONTENT ===== */
.container{padding:20px}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:15px}
.controls select,.controls input{
  padding:8px 12px;border-radius:10px;border:1px solid #c7d2fe
}
.controls button{
  padding:8px 14px;border-radius:10px;border:none;
  color:#fff;cursor:pointer;font-weight:600
}
.success{background:#16a34a}
.secondary{background:#64748b}
.danger{background:#dc2626}
.export{background:#2563eb}

/* ===== TABLE ===== */
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:18px;
  overflow:hidden;
  box-shadow:0 18px 40px rgba(0,0,0,.1)
}
th,td{
  padding:10px;
  border-bottom:1px solid #e5e7eb;
  font-size:14px
}
th{background:#f8fafc;text-align:left}

.badge{
  padding:4px 10px;
  border-radius:999px;
  color:#fff;
  font-size:12px
}
.green{background:#16a34a}
.yellow{background:#f59e0b}

.uid-btn{
  background:#eef2ff;
  border:1px solid #c7d2fe;
  padding:4px 8px;
  border-radius:8px;
  font-size:12px;
  cursor:pointer
}

.role-select{
  padding:6px;
  border-radius:6px;
  border:1px solid #c7d2fe
}

/* ===== MODAL ===== */
.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  backdrop-filter:blur(6px);
  display:flex;
  align-items:center;
  justify-content:center;
  opacity:0;
  pointer-events:none;
  transition:.3s;
  z-index:9999;
}
.modal-overlay.active{
  opacity:1;
  pointer-events:auto
}
.modal-box{
  background:#fff;
  padding:25px;
  border-radius:18px;
  width:320px;
  text-align:center
}
.modal-buttons{
  margin-top:20px;
  display:flex;
  gap:15px;
  justify-content:center
}
.modal-buttons button{
  padding:8px 16px;
  border:none;
  border-radius:999px;
  cursor:pointer;
  font-weight:600
}
.btn-cancel{background:#64748b;color:#fff}
.btn-confirm{background:#2563eb;color:#fff}

/* ===== LOADER ===== */
.loader{
  position:fixed;
  inset:0;
  background:rgba(255,255,255,.6);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:20px;
  font-weight:700;
  z-index:9998;
  display:none
}

/* ===== TOAST ===== */
.toast{
  position:fixed;
  bottom:30px;
  right:30px;
  padding:14px 20px;
  border-radius:12px;
  color:#fff;
  font-weight:600;
  opacity:0;
  transform:translateY(20px);
  transition:.3s;
  z-index:9999
}
.toast.show{
  opacity:1;
  transform:translateY(0)
}
.toast.success{background:#16a34a}
.toast.error{background:#dc2626}
</style>
</head>

<body>

<!-- NAVBAR -->
<div class="navbar">
  <div class="brand">
<img id="siteLogo" src="logo.png">
  </div>
</div>

<!-- ADMIN BUTTON BAR -->
<div class="admin-topbar">
  <button class="admin-btn" onclick="location.href='admin-dashboard.html'">‚¨Ö Back</button>
  <button class="admin-btn" onclick="location.href='admin-profile.html'">üë§ Profile</button>
  <button class="admin-btn" onclick="location.href='admin-logo.html'">üè∑ Logo</button>
  <button class="admin-btn" onclick="location.href='admin-hero.html'">‚úè Hero</button>
  <button class="admin-btn" onclick="location.href='admin-slider.html'">üß© Slider</button>
  <button class="admin-btn" onclick="location.href='admin-list.html'">üë• Admin List</button>
  <button class="admin-btn" onclick="location.href='add-admin.html'">‚ûï Add Admin</button>
  <button class="admin-btn" onclick="location.href='admin-logs.html'">üìú Admin Logs</button>
</div>

<div class="container">

<div class="controls">
  <select id="statusFilter" onchange="render()">
    <option value="all">All Users</option>
    <option value="approved">Approved</option>
    <option value="pending">Pending</option>
    <option value="admin">Admins Only</option>
    <option value="user">Users Only</option>
  </select>

  <input id="search" placeholder="Search..." oninput="render()">

  <button class="success" onclick="confirmBulk('approve')">Approve</button>
  <button class="secondary" onclick="confirmBulk('unapprove')">Unapprove</button>
  <button class="danger" onclick="confirmBulk('delete')">Delete</button>
  <button class="export" onclick="exportXLSX()">Export XLSX</button>
<button class="export" onclick="exportPDF()">Export PDF</button>
</div>

<table>
<thead>
<tr>
  <th><input type="checkbox" onclick="toggleAll(this)"></th>
  <th>#</th>
  <th>Name</th>
  <th>UID</th>
  <th>Email</th>
  <th>Role</th>
  <th>Created</th>
  <th>Status</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<div class="loader" id="loader">Loading...</div>

<div class="modal-overlay" id="modal">
  <div class="modal-box">
    <h3 id="modalText"></h3>
    <div class="modal-buttons">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-confirm" onclick="confirmAction()">Confirm</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,collection,onSnapshot,
  doc,getDoc,updateDoc,deleteDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";
 import { jsPDF } from "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/+esm";
import "https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/+esm";



const app=initializeApp({
  apiKey:"AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain:"sadri-villa-14c06.firebaseapp.com",
  projectId:"sadri-villa-14c06"
});

const auth=getAuth();
const db=getFirestore();
  // ===== LOAD SITE LOGO FROM FIRESTORE =====
async function loadLogo(){
  try{
    const snap = await getDoc(doc(db,"siteSettings","home"));

    if(snap.exists()){
      const data = snap.data();

      if(data.logo && data.logo.url){
        document.getElementById("siteLogo").src = data.logo.url;
      }
    }
  }catch(e){
    console.log("Logo load error", e);
  }
}




loadLogo();


let users=[];
let pendingAction=null;

/* AUTH CHECK */
onAuthStateChanged(auth,async user=>{
  if(!user){location.href="login.html";return;}
  const snap=await getDoc(doc(db,"users",user.uid));
  if(!snap.exists()||snap.data().role!=="admin"){
    location.href="dashboard.html";return;
  }
});

/* REALTIME USERS */
onSnapshot(collection(db,"users"),snap=>{
  users=[];
  snap.forEach(d=>users.push({uid:d.id,...d.data()}));
  users.sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0));
  render();
});

function formatDate(v){
  if(!v)return "-";
  if(v.seconds)return new Date(v.seconds*1000).toLocaleDateString("en-IN");
  return "-";
}

window.render=()=>{
  const tbody=document.getElementById("tbody");
  const q=document.getElementById("search").value.toLowerCase();
  const filter=document.getElementById("statusFilter").value;
  tbody.innerHTML="";

  let filtered=users.filter(u=>{
    if(filter==="admin"&&u.role!=="admin")return false;
    if(filter==="user"&&u.role==="admin")return false;
    if(filter==="approved"&&!u.approved)return false;
    if(filter==="pending"&&u.approved)return false;
    return (u.fullName||"").toLowerCase().includes(q)
        || (u.email||"").toLowerCase().includes(q);
  });

  filtered.forEach((u,i)=>{
    tbody.innerHTML+=`
    <tr>
      <td><input type="checkbox" class="sel" value="${u.uid}"></td>
      <td>${i+1}</td>
      <td>${u.fullName||"-"}</td>
      <td><button class="uid-btn" onclick="copyUID('${u.uid}')">Copy UID</button></td>
      <td>${u.email||"-"}</td>
      <td>
        <select class="role-select"
          onchange="confirmRoleChange('${u.uid}','${u.role}',this)">
          <option value="user" ${u.role!=="admin"?"selected":""}>User</option>
          <option value="admin" ${u.role==="admin"?"selected":""}>Admin</option>
        </select>
      </td>
      <td>${formatDate(u.createdAt)}</td>
      <td>
        <span class="badge ${u.approved?"green":"yellow"}">
          ${u.approved?"Approved":"Pending"}
        </span>
      </td>
      <td>
        <button onclick="confirmSingle('${u.uid}',${u.approved})">
          ${u.approved?"Unapprove":"Approve"}
        </button>
      </td>
    </tr>`;
  });
};

window.copyUID=(uid)=>{
  navigator.clipboard.writeText(uid);
  showToast("UID copied");
};

window.confirmRoleChange=(uid,oldRole,selectEl)=>{
  const newRole=selectEl.value;
  if(newRole===oldRole)return;
  pendingAction={type:"role",uid,newRole};
  document.getElementById("modalText").innerText=
    `Change role to ${newRole.toUpperCase()} ?`;
  document.getElementById("modal").classList.add("active");
};

window.toggleAll=(cb)=>{
  document.querySelectorAll(".sel").forEach(c=>c.checked=cb.checked);
};

window.confirmSingle=(id,isApproved)=>{
  pendingAction={type:"single",id,isApproved};
  document.getElementById("modalText").innerText=
    isApproved?"Unapprove this user?":"Approve this user?";
  document.getElementById("modal").classList.add("active");
};

window.confirmBulk=(action)=>{
  const ids=[...document.querySelectorAll(".sel:checked")].map(x=>x.value);
  if(ids.length===0){showToast("Select users first","error");return;}
  pendingAction={type:"bulk",action,ids};
  document.getElementById("modalText").innerText=
    `Confirm ${action.toUpperCase()} for selected users?`;
  document.getElementById("modal").classList.add("active");
};

window.closeModal=()=>{
  pendingAction=null;
  document.getElementById("modal").classList.remove("active");
};

window.confirmAction=async()=>{
  showLoader();
  try{
    if(pendingAction.type==="single"){
      await updateDoc(doc(db,"users",pendingAction.id),
        {approved:!pendingAction.isApproved});
    }
    else if(pendingAction.type==="bulk"){
      for(const id of pendingAction.ids){
        if(pendingAction.action==="approve")
          await updateDoc(doc(db,"users",id),{approved:true});
        if(pendingAction.action==="unapprove")
          await updateDoc(doc(db,"users",id),{approved:false});
        if(pendingAction.action==="delete")
          await deleteDoc(doc(db,"users",id));
      }
    }
    else if(pendingAction.type==="role"){
      await updateDoc(doc(db,"users",pendingAction.uid),
        {role:pendingAction.newRole});
    }
    showToast("Action completed successfully");
  }
  catch(e){
    showToast("Something went wrong","error");
  }
  hideLoader();
  closeModal();
};

function showLoader(){
  document.getElementById("loader").style.display="flex";
}
function hideLoader(){
  document.getElementById("loader").style.display="none";
}
function showToast(msg,type="success"){
  const t=document.getElementById("toast");
  t.innerText=msg;
  t.className="toast "+type+" show";
  setTimeout(()=>t.classList.remove("show"),3000);
}

window.exportXLSX = () => {

  showLoader();

  try{

    // =============================
    // Collect All Dynamic Fields
    // =============================
    const adminFieldSet = new Set();
    const customFieldSet = new Set();

    users.forEach(u=>{
      Object.keys(u.adminFields || {}).forEach(k=>adminFieldSet.add(k));
      Object.keys(u.userCustomFields || {}).forEach(k=>customFieldSet.add(k));
    });

    const adminFields = Array.from(adminFieldSet);
    const customFields = Array.from(customFieldSet);

    // =============================
    // Create Header Row
    // =============================
    const header = [
      "Full Name",
      "Email",
      "Phone",
      "Role",
      "Approved",
      "Created At",
      ...adminFields.map(f=>"ADMIN - "+formatLabel(f)),
      ...customFields.map(f=>"CUSTOM - "+formatLabel(f)),
    ];

    const data = [];

    users.forEach(u=>{

      const row = [
        u.fullName || "-",
        u.email || "-",
        u.phone || "-",
        u.role || "-",
        u.approved ? "Yes" : "No",
        formatDate(u.createdAt)
      ];

      adminFields.forEach(f=>{
        row.push(u.adminFields?.[f] || "-");
      });

      customFields.forEach(f=>{
        row.push(u.userCustomFields?.[f]?.value || "-");
      });

      data.push(row);
    });

    // =============================
    // Build Sheet
    // =============================
    const ws = XLSX.utils.aoa_to_sheet([header, ...data]);

    // Column width
    ws["!cols"] = header.map(()=>({wch:22}));

    // Enable filter
    ws["!autofilter"] = {
      ref: XLSX.utils.encode_range({
        s: {r:0,c:0},
        e: {r:data.length,c:header.length-1}
      })
    };

    // =============================
    // Styling (Advanced)
    // =============================
    const range = XLSX.utils.decode_range(ws["!ref"]);

    for(let R = range.s.r; R <= range.e.r; ++R){
      for(let C = range.s.c; C <= range.e.c; ++C){

        const cellAddress = XLSX.utils.encode_cell({r:R,c:C});
        if(!ws[cellAddress]) continue;

        ws[cellAddress].s = {
          border: {
            top:{style:"thin"},
            bottom:{style:"thin"},
            left:{style:"thin"},
            right:{style:"thin"}
          },
          alignment:{vertical:"center",horizontal:"left"}
        };

        // Header row style
        if(R === 0){
          ws[cellAddress].s.fill = {
            patternType:"solid",
            fgColor:{rgb:"2563EB"}
          };
          ws[cellAddress].s.font = {
            bold:true,
            color:{rgb:"FFFFFF"}
          };
        }
      }
    }

    // =============================
    // Workbook
    // =============================
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "All Users");

    XLSX.writeFile(wb, "SadriVilla_All_Users.xlsx");

    showToast("Professional Excel Export Complete");

  }catch(e){
    showToast("Export Failed","error");
  }

  hideLoader();
};
function formatLabel(key){
  return key
    .replace(/([A-Z])/g," $1")
    .replace(/_/g," ")
    .replace(/\b\w/g,l=>l.toUpperCase());
}
  window.exportPDF = async () => {

  showLoader();

  try{

    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    
   


    // ===== HEADER =====

     // ===== ADD LOGO =====
const logoImg = document.getElementById("siteLogo");
if(logoImg && logoImg.src){
  doc.addImage(logoImg.src, "PNG", 14, 10, 25, 12);
}
    doc.setFontSize(18);
    doc.text("Sadri Villa - Users Report", pageWidth/2, 20, {align:"center"});

    doc.setFontSize(10);
    doc.text("Generated: " + new Date().toLocaleString(),
      pageWidth-14, 30, {align:"right"});

    let y = 40;

    for(let i=0; i<users.length; i++){

      const u = users[i];

    if(i !== 0){
  doc.addPage();
  y = 20;

  // Re-add logo on new page
  if(logoImg && logoImg.src){
    doc.addImage(logoImg.src, "PNG", 14, 10, 25, 12);
  }
}


      // Section Title
      doc.setFillColor(37,99,235);
      doc.setTextColor(255);
      doc.rect(14, y-6, pageWidth-28, 10, "F");
      doc.text(`User ${i+1}`, 16, y);
      doc.setTextColor(0);
      y += 12;
      // ===== ADD PROFILE PHOTO =====
if(u.profilePhoto){
  try{
    const img = await fetch(u.profilePhoto);
    const blob = await img.blob();
    const reader = new FileReader();

    await new Promise(resolve=>{
      reader.onload = function(){
        doc.addImage(reader.result, "JPEG", pageWidth-40, y-10, 25, 25);
        resolve();
      };
      reader.readAsDataURL(blob);
    });

  }catch(e){
    console.log("Image load failed");
  }
}


      // ===== USER DETAILS =====
      doc.autoTable({
        startY: y,
        theme: "grid",
        headStyles:{fillColor:[16,185,129],textColor:255},
        head:[["User Details",""]],
        body:[
          ["Full Name", u.fullName || "-"],
          ["Email", u.email || "-"],
          ["Phone", u.phone || "-"],
          ["Role", u.role || "-"],
          ["Approved", u.approved ? "Yes":"No"]
        ]
      });

      y = doc.lastAutoTable.finalY + 8;

      // ===== ADMIN FIELDS =====
      if(u.adminFields){
        const rows = Object.entries(u.adminFields)
          .map(([k,v])=>[formatLabel(k), v || "-"]);

        doc.autoTable({
          startY: y,
          theme: "grid",
          headStyles:{fillColor:[59,130,246],textColor:255},
          head:[["Admin Fields",""]],
          body:rows
        });

        y = doc.lastAutoTable.finalY + 8;
      }

      // ===== CUSTOM FIELDS =====
if(u.userCustomFields){
  const rows = Object.entries(u.userCustomFields)
    .map(([k,v])=>[formatLabel(k), v.value || "-"]);

  doc.autoTable({
    startY: y,
    theme: "grid",
    headStyles:{fillColor:[168,85,247],textColor:255},
    head:[["Custom Fields",""]],
    body:rows
  });
  y = doc.lastAutoTable.finalY + 8;
      }

    }

    // ===== FOOTER WITH PAGE NUMBERS =====
    const totalPages = doc.getNumberOfPages();

    for(let p=1; p<=totalPages; p++){
      doc.setPage(p);
      doc.setFontSize(9);
      doc.setTextColor(120);

      doc.text(
        `¬© ${new Date().getFullYear()} Sadri Villa | Confidential`,
        pageWidth/2,
        pageHeight-10,
        {align:"center"}
      );

      doc.text(
        `Page ${p} of ${totalPages}`,
        pageWidth-20,
        pageHeight-10,
        {align:"right"}
      );
    }

    doc.save("SadriVilla_Users_Report.pdf");

    showToast("PDF Export Complete");

  }catch(e){
    showToast("PDF Export Failed","error");
  }

  hideLoader();
};


</script>

</body>
</html>
