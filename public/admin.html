<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel | Sadri Villa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{margin:0;font-family:Arial;background:#eef2ff}

/* NAVBAR */
.navbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 24px;background:#eaf2ff;
  box-shadow:0 4px 12px rgba(0,0,0,.08)
}
.nav-left{display:flex;align-items:center;gap:12px}
.nav-left img{height:38px}
.nav-left h3{margin:0}

/* ADMIN BUTTON BAR */
.admin-bar{
  display:flex;gap:12px;flex-wrap:wrap;
  padding:16px 24px
}
.admin-bar button{
  padding:10px 16px;border:none;border-radius:14px;
  background:linear-gradient(135deg,#4f46e5,#7c3aed);
  color:#fff;font-weight:bold;cursor:pointer
}

/* PAGE */
.container{padding:20px}

.controls{
  display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px
}
.controls select,.controls input,.controls button{
  padding:8px 12px;border-radius:10px;border:none
}
.controls select,.controls input{border:1px solid #c7d2fe}
.success{background:#16a34a;color:#fff}
.secondary{background:#64748b;color:#fff}
.danger{background:#dc2626;color:#fff}

table{
  width:100%;border-collapse:collapse;background:#fff;
  border-radius:18px;overflow:hidden;
  box-shadow:0 18px 40px rgba(0,0,0,.1)
}
th,td{padding:12px;border-bottom:1px solid #e5e7eb;font-size:14px}
th{background:#f8fafc;text-align:left}

.badge{
  padding:4px 10px;border-radius:999px;
  color:#fff;font-size:12px
}
.green{background:#16a34a}
.yellow{background:#f59e0b}

.uid-btn{
  background:#eef2ff;border:1px solid #c7d2fe;
  padding:4px 8px;border-radius:8px;
  font-size:12px;cursor:pointer
}
</style>
</head>

<body>

<!-- NAVBAR -->
<div class="navbar">
  <div class="nav-left">
    <img src="images/logo.png" alt="Sadri Villa">
    <h3>Sadri Villa ‚Äì Admin</h3>
  </div>
</div>

<!-- ADMIN BUTTONS -->
<div class="admin-bar">
  <button onclick="location.href='admin-dashboard.html'">‚Üê Dashboard</button>
  <button onclick="location.href='admin-list.html'">üë• Admin List</button>
  <button onclick="location.href='add-admin.html'">‚ûï Add Admin</button>
  <button onclick="location.href='admin-logs.html'">üìú Admin Logs</button>
</div>

<!-- CONTENT -->
<div class="container">

<div class="controls">
  <select id="statusFilter" onchange="render()">
    <option value="all">All Status</option>
    <option value="approved">Approved</option>
    <option value="pending">Pending</option>
  </select>

  <input id="search" placeholder="Search by Name / Email / Phone" oninput="render()">

  <button class="success" onclick="bulkApprove()">Approve</button>
  <button class="secondary" onclick="bulkUnapprove()">Unapprove</button>
  <button class="danger" onclick="bulkDelete()">Delete</button>
  <button onclick="exportXLSX()">Export XLSX</button>
</div>

<table>
<thead>
<tr>
  <th><input type="checkbox" onclick="toggleAll(this)"></th>
  <th>Name</th>
  <th>UID</th>
  <th>Email</th>
  <th>Phone</th>
  <th>Created</th>
  <th>Status</th>
  <th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth,onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import {
  getFirestore,collection,getDocs,doc,updateDoc,deleteDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";

/* FIREBASE */
const app = initializeApp({
  apiKey:"AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain:"sadri-villa-14c06.firebaseapp.com",
  projectId:"sadri-villa-14c06"
});
const auth=getAuth(app);
const db=getFirestore(app);

const tbody=document.getElementById("tbody");
const search=document.getElementById("search");
const statusFilter=document.getElementById("statusFilter");

let users=[];

/* AUTH */
onAuthStateChanged(auth, async user=>{
  if(!user) return location.href="login.html";
  const token=await user.getIdTokenResult(true);
  if(!token.claims.admin){
    alert("Admin only");
    return location.href="dashboard.html";
  }
  load();
});

/* LOAD USERS */
async function load(){
  users=[];
  const snap=await getDocs(collection(db,"users"));
  snap.forEach(d=>users.push({uid:d.id,...d.data()}));
  render();
}

/* RENDER */
window.render=()=>{
  tbody.innerHTML="";
  const q=search.value.toLowerCase();

  users.filter(u=>{
    if(statusFilter.value==="approved"&&!u.approved) return false;
    if(statusFilter.value==="pending"&&u.approved) return false;

    const name=(u.fullName||u.adminFields?.Name||u.displayName||"").toLowerCase();
    const email=(u.email||u.adminFields?.Email||"").toLowerCase();
    const phone=(u.phone||u.adminFields?.Phone||"");

    return name.includes(q)||email.includes(q)||phone.includes(q);
  }).forEach(u=>{
    const name=u.fullName||u.adminFields?.Name||u.displayName||"-";
    const email=u.email||u.adminFields?.Email||"-";
    const phone=u.phone||u.adminFields?.Phone||"-";

    tbody.innerHTML+=`
    <tr>
      <td><input type="checkbox" class="sel" value="${u.uid}"></td>
      <td>${name}</td>
      <td><button class="uid-btn" onclick="copyUID('${u.uid}',this)">Copy UID</button></td>
      <td>${email}</td>
      <td>${phone}</td>
      <td>${u.createdAt?new Date(u.createdAt).toLocaleDateString("en-IN"):"-"}</td>
      <td>
        <span class="badge ${u.approved?"green":"yellow"}">
          ${u.approved?"Approved":"Pending"}
        </span>
      </td>
      <td>
        <button onclick="toggle('${u.uid}',${u.approved})">
          ${u.approved?"Unapprove":"Approve"}
        </button>
      </td>
    </tr>`;
  });
};

/* UID COPY */
window.copyUID=async(uid,btn)=>{
  await navigator.clipboard.writeText(uid);
  const t=btn.innerText;
  btn.innerText="Copied ‚úì";
  setTimeout(()=>btn.innerText=t,1200);
};

/* ACTIONS */
window.toggleAll=cb=>
  document.querySelectorAll(".sel").forEach(c=>c.checked=cb.checked);

const selected=()=>[...document.querySelectorAll(".sel:checked")].map(x=>x.value);

window.toggle=async(id,v)=>{
  await updateDoc(doc(db,"users",id),{approved:!v});
  load();
};

window.bulkApprove=async()=>{
  for(const id of selected())
    await updateDoc(doc(db,"users",id),{approved:true});
  load();
};

window.bulkUnapprove=async()=>{
  for(const id of selected())
    await updateDoc(doc(db,"users",id),{approved:false});
  load();
};

window.bulkDelete=async()=>{
  for(const id of selected())
    await deleteDoc(doc(db,"users",id));
  load();
};

/* EXPORT */
window.exportXLSX=()=>{
  const rows=users.map(u=>({
    UID:u.uid,
    Name:u.fullName||u.adminFields?.Name||u.displayName||"",
    Email:u.email||u.adminFields?.Email||"",
    Phone:u.phone||u.adminFields?.Phone||"",
    Approved:u.approved?"Yes":"No",
    Created:u.createdAt||""
  }));
  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Users");
  XLSX.writeFile(wb,"users_export.xlsx");
};
</script>

</body>
</html>
