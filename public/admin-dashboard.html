<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard â€“ Sadri Villa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicon.png">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{--bg:#eef2ff}
body{margin:0;font-family:Arial;background:var(--bg)}

.header{
  margin:20px;padding:22px;border-radius:22px;
  background:linear-gradient(135deg,#4f46e5,#7c3aed,#9333ea);
  color:#fff;display:flex;justify-content:space-between;align-items:center
}
.header-left{display:flex;gap:12px;align-items:center}
.header button{
  padding:10px 16px;border:none;border-radius:14px;
  background:#fff;color:#4f46e5;font-weight:600;cursor:pointer
}

.profile-wrap{position:relative}
.profile-icon{
  width:44px;height:44px;border-radius:50%;
  border:2px solid #fff;cursor:pointer
}
.profile-menu{
  position:absolute;right:0;top:54px;background:#fff;
  border-radius:14px;width:200px;
  box-shadow:0 20px 40px rgba(0,0,0,.25);
  display:none;overflow:hidden;z-index:3000
}
.profile-menu div{padding:12px;border-bottom:1px solid #e5e7eb}
.profile-menu button{
  width:100%;border:none;background:#fff;
  padding:12px;text-align:left;cursor:pointer
}
.profile-menu button:hover{background:#f3f4f6}

.container{
  padding:20px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(360px,1fr));
  gap:22px
}
.card{
  background:#fff;padding:22px;border-radius:20px;
  box-shadow:0 12px 28px rgba(0,0,0,.08);
  cursor:pointer
}
.card h3{margin-top:0}
.list-item{font-size:13px;padding:4px 0}

#pendingAlertIcon{
  position:fixed;top:16px;right:16px;
  width:48px;height:48px;border-radius:50%;
  background:#fff;display:none;
  align-items:center;justify-content:center;
  font-size:22px;cursor:pointer;
  box-shadow:0 12px 30px rgba(0,0,0,.25);
  z-index:4000
}
#pendingBadge{
  position:absolute;top:-6px;right:-6px;
  background:#dc2626;color:#fff;
  font-size:12px;font-weight:bold;
  padding:3px 7px;border-radius:999px
}
</style>
</head>

<body>

<!-- ðŸ”” ALERT -->
<div id="pendingAlertIcon" onclick="location.href='admin-approval-requests.html'">
  ðŸ”” <span id="pendingBadge">0</span>
</div>

<!-- HEADER -->
<div class="header">
  <div class="header-left">
    <h2>Admin Dashboard</h2>
    <button onclick="location.href='admin.html'">ðŸ‘¥ Admin Panel</button>
    <button onclick="location.href='admin-profile-fields.html'">ðŸ§© Profile Fields</button>
    <button onclick="location.href='dashboard.html'">â¬… User Dashboard</button>
  </div>

  <div class="profile-wrap">
    <img src="images/default-user.png" class="profile-icon" onclick="toggleMenu()">
    <div class="profile-menu" id="profileMenu">
      <div><b id="pName">Admin</b><br><small>Admin</small></div>
      <button onclick="location.href='profile.html'">ðŸ‘¤ Profile</button>
      <button onclick="logout()">ðŸšª Logout</button>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div class="container">

  <div class="card">
    <h3>Total Users</h3>
    <h1 id="totalUsers">â€”</h1>
  </div>

  <div class="card" onclick="location.href='admin-media.html'">
    <h3>ðŸ–¼ Manage Site Media</h3>
    <p>Update logo, hero image & homepage slider</p>
  </div>

  <div class="card">
    <h3>User Approval Status</h3>
    <canvas id="approvalChart"></canvas>
    <button onclick="showAllApprovals()">Show All</button>
    <div id="approvalList"></div>
  </div>

  <div class="card">
    <h3>User Age Distribution</h3>
    <canvas id="ageChart"></canvas>
  </div>

  <div class="card">
    <h3>Profile Completion</h3>
    <canvas id="profileChart"></canvas>
    <button onclick="showAllProfiles()">Show All</button>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* ðŸ”¥ FIREBASE */
const app = initializeApp({
  apiKey: "AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain: "sadri-villa-14c06.firebaseapp.com",
  projectId: "sadri-villa-14c06"
});
const auth = getAuth(app);
const db = getFirestore(app);

/* ðŸ” AUTH + ADMIN CLAIM */
onAuthStateChanged(auth, async user => {
  if (!user) return location.href = "login.html";

const snap = await getDoc(doc(db, "users", user.uid));

if (!snap.exists() || snap.data().role !== "admin") {
  alert("Access denied");
  return location.href = "dashboard.html";
}

pName.innerText = snap.data().fullName || "Admin";


  const snap = await getDoc(doc(db, "users", user.uid));
  pName.innerText = snap.exists() ? snap.data().fullName || "Admin" : "Admin";

  loadDashboard();
});

/* MENU */
window.toggleMenu = () =>
  profileMenu.style.display =
    profileMenu.style.display === "block" ? "none" : "block";

window.logout = async () => {
  await signOut(auth);
  location.href = "login.html";
};

/* LOAD DATA */
let allUsers = [];
async function loadDashboard() {
  const snap = await getDocs(collection(db, "users"));
  allUsers = snap.docs.map(d => d.data());
  totalUsers.innerText = allUsers.length;
  renderApprovalChart();
  renderAgeChart();
  renderProfileChart();
  renderPendingAlerts();
}

/* CHARTS */
function renderApprovalChart() {
  const approved = allUsers.filter(u => u.approved === true).length;
  const pending = allUsers.length - approved;

  new Chart(approvalChart, {
    type: "doughnut",
    data: {
      labels: ["Approved", "Pending"],
      datasets: [{ data: [approved, pending] }]
    }
  });
}

function renderAgeChart() {
  new Chart(ageChart, {
    type: "bar",
    data: {
      labels: ["Young", "Adult", "Senior"],
      datasets: [{ data: [10, 20, 5] }]
    }
  });
}

function renderProfileChart() {
  new Chart(profileChart, {
    type: "bar",
    data: {
      labels: allUsers.map(u => u.fullName || "User"),
      datasets: [{ data: allUsers.map(() => 80) }]
    }
  });
}

function renderPendingAlerts() {
  const pending = allUsers.filter(u => u.approved !== true);
  if (pending.length) {
    pendingBadge.innerText = pending.length;
    pendingAlertIcon.style.display = "flex";
  }
}
</script>

</body>
</html>
