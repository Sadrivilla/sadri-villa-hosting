<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard â€“ Sadri Villa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{--bg:#eef2ff}
body{margin:0;font-family:Arial;background:var(--bg)}

/* HEADER */
.header{
  margin:20px;padding:22px;border-radius:22px;
  background:linear-gradient(135deg,#4f46e5,#7c3aed,#9333ea);
  color:#fff;display:flex;justify-content:space-between;align-items:center
}
.header-left{display:flex;gap:12px;align-items:center}
.header button{
  padding:10px 16px;border:none;border-radius:14px;
  background:#fff;color:#4f46e5;font-weight:600;cursor:pointer
}

/* PROFILE MENU */
.profile-wrap{position:relative}
.profile-icon{
  width:44px;height:44px;border-radius:50%;
  border:2px solid #fff;cursor:pointer
}
.profile-menu{
  position:absolute;right:0;top:54px;background:#fff;
  border-radius:14px;width:200px;
  box-shadow:0 20px 40px rgba(0,0,0,.25);
  display:none;overflow:hidden;z-index:3000
}
.profile-menu div{padding:12px;border-bottom:1px solid #e5e7eb}
.profile-menu button{
  width:100%;border:none;background:#fff;
  padding:12px;text-align:left;cursor:pointer
}
.profile-menu button:hover{background:#f3f4f6}

/* GRID */
.container{
  padding:20px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(360px,1fr));
  gap:22px
}
.card{
  background:#fff;padding:22px;border-radius:20px;
  box-shadow:0 12px 28px rgba(0,0,0,.08);
  cursor:pointer
}
.card h3{margin-top:0}
.list-item{font-size:13px;padding:4px 0}

/* ðŸ”” ALERT ICON */
#pendingAlertIcon{
  position:fixed;top:16px;right:16px;
  width:48px;height:48px;border-radius:50%;
  background:#fff;display:none;
  align-items:center;justify-content:center;
  font-size:22px;cursor:pointer;
  box-shadow:0 12px 30px rgba(0,0,0,.25);
  z-index:4000
}
#pendingBadge{
  position:absolute;top:-6px;right:-6px;
  background:#dc2626;color:#fff;
  font-size:12px;font-weight:bold;
  padding:3px 7px;border-radius:999px
}
</style>
</head>

<body>

<!-- ðŸ”” FIXED ALERT -->
<div id="pendingAlertIcon" onclick="location.href='admin-approval-requests.html'">
  ðŸ”” <span id="pendingBadge">0</span>
</div>

<!-- HEADER -->
<div class="header">
  <div class="header-left">
    <h2>Admin Dashboard</h2>
    <button onclick="location.href='admin.html'">ðŸ‘¥ Admin Panel</button>
    <button onclick="location.href='admin-profile-fields.html'">ðŸ§© Profile Fields</button>
    <button onclick="location.href='dashboard.html'">â¬… User Dashboard</button>
  </div>

  <div class="profile-wrap">
    <img src="images/default-user.png" class="profile-icon" onclick="toggleMenu()">
    <div class="profile-menu" id="profileMenu">
      <div><b id="pName">Admin</b><br><small>Admin</small></div>
      <button onclick="location.href='profile.html'">ðŸ‘¤ Profile</button>
      <button onclick="logout()">ðŸšª Logout</button>
    </div>
  </div>
</div>

<!-- DASHBOARD -->
<div class="container">

  <div class="card" onclick="location.href='admin.html'">
    <h3>Total Users</h3>
    <h1 id="totalUsers">â€”</h1>
  </div>

  <div class="card" onclick="location.href='manage-profile-fields.html'">
    <h3>ðŸ§© Manage Profile Fields</h3>
    <p style="font-size:13px;color:#6b7280">
      Control signup & profile form fields, validation and visibility
    </p>
  </div>

  <!-- âœ… NEW MEDIA MANAGER CARD -->
  <div class="card" onclick="location.href='admin-media.html'">
    <h3>ðŸ–¼ Manage Site Media</h3>
    <p style="font-size:13px;color:#6b7280">
      Update logo, hero image, and homepage slider
    </p>
  </div>

  <div class="card">
    <h3>User Approval Status</h3>
    <canvas id="approvalChart"></canvas>
    <button onclick="showAllApprovals()">Show All</button>
    <div id="approvalList"></div>
  </div>

  <div class="card">
    <h3>User Age Distribution</h3>
    <canvas id="ageChart"></canvas>
  </div>

  <div class="card">
    <h3>Profile Completion (User-wise)</h3>
    <canvas id="profileChart"></canvas>
    <button onclick="showAllProfiles()">Show All</button>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth,onAuthStateChanged,signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore,collection,getDocs,doc,getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* FIREBASE */
const app=initializeApp({
  apiKey:"AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain:"sadri-villa-14c06.firebaseapp.com",
  projectId:"sadri-villa-14c06"
});
const auth=getAuth(app);
const db=getFirestore(app);

/* STATE */
let allUsers=[];
let showAllApprovalUsers=false;
let showAllProfileUsers=false;
let approvalChartInst=null;
let profileChartInst=null;

/* AUTH */
onAuthStateChanged(auth,async user=>{
  if(!user) return location.href="login.html";
  const snap=await getDoc(doc(db,"users",user.uid));
  if(!snap.exists()||snap.data().role!=="admin"){
    alert("Access denied");
    return location.href="dashboard.html";
  }
  pName.innerText=snap.data().fullName||"Admin";
  loadDashboard();
});

/* MENU */
window.toggleMenu=()=>profileMenu.style.display=
  profileMenu.style.display==="block"?"none":"block";
window.logout=async()=>{await signOut(auth);location.href="login.html";};

/* LOAD */
async function loadDashboard(){
  const snap=await getDocs(collection(db,"users"));
  allUsers=snap.docs.map(d=>({id:d.id,...d.data()}));
  totalUsers.innerText=allUsers.length;
  renderApprovalChart();
  renderAgeChart();
  renderProfileChart();
  renderPendingAlerts();
}

/* APPROVAL */
function renderApprovalChart(){
  if(approvalChartInst) approvalChartInst.destroy();

  const approved = allUsers.filter(u=>u.approved===true).length;
  const pending  = allUsers.length - approved;

  approvalChartInst=new Chart(approvalChart,{
    type:"doughnut",
    data:{
      labels:["Approved","Pending"],
      datasets:[{
        data:[approved,pending],
        backgroundColor:["#16a34a","#f59e0b"]
      }]
    }
  });

  renderApprovalList();
}

function renderApprovalList(){
  approvalList.innerHTML="";
  (showAllApprovalUsers?allUsers:allUsers.slice(0,5)).forEach(u=>{
    approvalList.innerHTML+=`
      <div class="list-item">
        ${u.fullName||"User"} â€“
        <b>${u.approved?"Approved":"Pending"}</b>
      </div>`;
  });
}

window.showAllApprovals=()=>{
  showAllApprovalUsers=true;
  renderApprovalList();
};

/* AGE */
function renderAgeChart(){
  const b=[0,0,0,0,0];
  allUsers.forEach(u=>{
    const dob=u.dob||u.adminFields?.["Date of birth"];
    if(!dob) return;
    const a=Math.floor((Date.now()-new Date(dob))/31557600000);
    if(a<=20)b[0]++;else if(a<=40)b[1]++;
    else if(a<=60)b[2]++;else if(a<=80)b[3]++;else b[4]++;
  });
  new Chart(ageChart,{
    type:"bar",
    data:{
      labels:["1â€“20","21â€“40","41â€“60","61â€“80","81â€“100"],
      datasets:[{data:b,backgroundColor:"#6366f1"}]
    }
  });
}

/* PROFILE */
function completion(u){
  const f=u.adminFields||{};
  const t=Object.keys(f).length||1;
  const filled=Object.values(f).filter(v=>v).length;
  return Math.round((filled/t)*100);
}
function renderProfileChart(){
  if(profileChartInst) profileChartInst.destroy();
  const list=showAllProfileUsers?allUsers:allUsers.slice(0,5);
  profileChartInst=new Chart(profileChart,{
    type:"bar",
    data:{
      labels:list.map(u=>u.fullName||"User"),
      datasets:[{data:list.map(completion),backgroundColor:"#22c55e"}]
    },
    options:{scales:{y:{max:100}}}
  });
}
window.showAllProfiles=()=>{
  showAllProfileUsers=true;
  renderProfileChart();
};

/* ðŸ”” ALERT */
function renderPendingAlerts(){
  const pending = allUsers.filter(
    u => u.approved !== true && u.approvalReminder === true
  );
  if(pending.length){
    pendingBadge.innerText = pending.length;
    pendingAlertIcon.style.display = "flex";
  }else{
    pendingAlertIcon.style.display = "none";
  }
}
</script>

</body>
</html>
