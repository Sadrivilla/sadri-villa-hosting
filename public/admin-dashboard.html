<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard â€“ Sadri Villa</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicon.png">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  
:root{--bg:#eef2ff}
body{
  margin:0;
  font-family:Arial;
  background:var(--bg);
  overflow-x:hidden;
}

canvas {
  max-height: 260px;
}




.profile-menu div{padding:12px;border-bottom:1px solid #e5e7eb}
.profile-menu button{
  width:100%;border:none;background:#fff;
  padding:12px;text-align:left;cursor:pointer
}
.profile-menu button:hover{background:#f3f4f6}

.container{
  padding:140px 20px 40px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(360px,1fr));
  gap:22px;
}

.card{
  background:#fff;padding:22px;border-radius:20px;
  box-shadow:0 12px 28px rgba(0,0,0,.08);
  cursor:pointer
}
.card h3{margin-top:0}
.list-item{font-size:13px;padding:4px 0}



  /* ADMIN NAVBAR */
.admin-navbar{
  position:fixed;
  top:50px; /* below main navbar */
  left:0;
  right:0;
  background:#ffffff;
  border-bottom:1px solid #e5e7eb;
  display:flex;
  gap:20px;
  padding:10px 20px;
  overflow-x:auto;
  z-index:999;
}

.admin-navbar a{
  text-decoration:none;
  color:#4f46e5;
  font-weight:600;
  white-space:nowrap;
  padding:6px 10px;
  border-radius:8px;
  transition:.2s;
}

.admin-navbar a:hover{
  background:#eef2ff;
}
  .admin-navbar::-webkit-scrollbar {
  height: 6px;
}
.admin-navbar::-webkit-scrollbar-thumb {
  background: #d1d5db;
  border-radius: 10px;
}

   /* MAIN NAVBAR */
.navbar{
  position:fixed;
  top:0;left:0;right:0;
  height:50px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:rgba(255,255,255,0.95);
  backdrop-filter:blur(8px);
  border-bottom:1px solid rgba(0,0,0,.08);
  z-index:1000;
  padding:0 20px;
}
  

.brand{
  display:flex;
  align-items:center;
  gap:15px;
}

.brand img{
  height:40px;
  display:none;
}

.nav-title{
  font-weight:700;
}

.profile-wrapper{
  position:relative;
  cursor:pointer;
}

#profilePhoto{
  width:40px;
  height:40px;
  border-radius:50%;
  object-fit:cover;
  border:2px solid #38bdf8;
}

#profileCard{
  position:absolute;
  top:55px;
  right:0;
  background:#fff;
  border-radius:12px;
  box-shadow:0 5px 20px rgba(0,0,0,.2);
  width:200px;
  display:none;
  overflow:hidden;
}

#profileCard a{
  display:block;
  padding:12px;
  text-decoration:none;
  color:#333;
  border-bottom:1px solid #eee;
}

#profileCard a:hover{
  background:#f1f5f9;
}

#profileCard.show{
  display:block;
}
  /* SLIDER */
.gallery{
  width:100%;
  background:#f1f5f9;
  padding:40px 0;
  overflow:hidden;
}

.track{
  display:flex;
  gap:20px;
  width:max-content;
}

.track.scrolling{
  animation:scroll linear infinite;
}

.track:hover{
  animation-play-state:paused;
}

.track img{
  width:320px;
  height:220px;
  object-fit:cover;
  border-radius:20px;
  box-shadow:0 8px 25px rgba(0,0,0,.15);
  transition:.3s;
  cursor:pointer;
}

.track img:hover{
  transform:scale(1.03);
}

@keyframes scroll{
  from{transform:translateX(0)}
  to{transform:translateX(-50%)}
}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
}

.modal-content{
  background:#fff;
  padding:20px;
  border-radius:20px;
}

.modal-content img{
  max-width:500px;
  border-radius:15px;
}
/* RIGHT NAV SECTION */
.nav-right{
  display:flex;
  align-items:center;
  gap:18px;
}

/* BELL */
.bell{
  position:relative;
  font-size:20px;
  cursor:pointer;
  display:none; /* hidden until count > 0 */
  transition:.2s ease;
}

.bell:hover{
  transform:scale(1.1);
}

/* BADGE */
.bell-badge{
  position:absolute;
  top:-6px;
  right:-10px;
  background:#dc2626;
  color:#fff;
  font-size:11px;
  font-weight:bold;
  padding:3px 6px;
  border-radius:50%;
}


</style>
</head>

<body>

  <!-- MAIN NAVBAR (Same as dashboard.html) -->
<div class="navbar">
  <div class="brand">
    <img id="siteLogo">
    <div class="nav-title" id="welcomeName">Sadri Villa â€“ Admin</div>
  </div>

  <div class="nav-right">

    <!-- ðŸ”” BELL -->
    <div id="pendingAlertIcon" class="bell"
         onclick="location.href='admin-approval-requests.html'">
      ðŸ””
      <span id="pendingBadge" class="bell-badge">0</span>
    </div>

    <div class="profile-wrapper">
      <img id="profilePhoto"
       src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png">
      <div id="profileCard">
        <a href="profile.html">Profile</a>
        <a href="change-password.html">Change Password</a>
        <a href="#" id="logoutBtn" style="color:red">Logout</a>
      </div>
    </div>

  </div> <!-- CLOSE nav-right -->

</div> <!-- CLOSE navbar -->

<!-- ADMIN NAVBAR -->
<div class="admin-navbar">
  <a href="admin.html">Admin Panel</a>
  <a href="admin-profile.html">Profile Fields</a>
  <a href="admin-logo.html">Logo</a>
  <a href="admin-hero.html">Hero</a>
  <a href="admin-slider.html">Slider</a>
  <a href="admin-villa-sections.html">Index Images-With Text</a>
  <a href="admin-list.html">Admin List</a>
  <a href="add-admin.html">Add Admin</a>
  <a href="admin-logs.html">Logs</a>
  <a href="dashboard.html">User Dashboard</a>
</div>




<!-- DASHBOARD -->
<div class="container">

  <div class="card">
    <h3>Total Users</h3>
    <h1 id="totalUsers">â€”</h1>
  </div>

  <div class="card" onclick="location.href='admin-media.html'">
    <h3>ðŸ–¼ Manage Site Media</h3>
    <p>Update logo, hero image & homepage slider</p>
  </div>

  <div class="card">
    <h3>User Approval Status</h3>
    <canvas id="approvalChart"></canvas>
    <button onclick="showAllApprovals()">Show All</button>
    <div id="approvalList"></div>
  </div>

  <div class="card">
    <h3>User Age Distribution</h3>
    <canvas id="ageChart"></canvas>
  </div>

  <div class="card">
    <h3>Profile Completion</h3>
    <canvas id="profileChart"></canvas>
    <button onclick="showAllProfiles()">Show All</button>
  </div>

</div>
  <!-- EDGE TO EDGE SLIDER -->
<section class="gallery">
  <div class="track" id="galleryTrack"></div>
</section>

<!-- IMAGE POPUP -->
<div class="modal" id="imgModal">
  <div class="modal-content">
    <img id="modalImg">
  </div>
</div>


<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { 
  getAuth, 
  onAuthStateChanged, 
  signOut 
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
  getFirestore,
  collection,
  getDocs,
  query,
  where,
  onSnapshot,
  doc,
  getDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

/* FIREBASE */
const app = initializeApp({
  apiKey:"AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain:"sadri-villa-14c06.firebaseapp.com",
  projectId:"sadri-villa-14c06"
});
const auth = getAuth(app);
const db = getFirestore(app);

let approvalChartInstance = null;
let ageChartInstance = null;
let profileChartInstance = null;
let cachedUsers = [];
  let unsubscribeSiteSettings = null;


/* ADMIN CHECK */
onAuthStateChanged(auth, async user => {
  if (!user) {
    location.href = "login.html";
    return;
  }

  const snap = await getDoc(doc(db, "users", user.uid));

  if (!snap.exists()) {
    location.href = "dashboard.html";
    return;
  }

  const data = snap.data();

  if (data.role !== "admin") {
    alert("Access denied");
    location.href = "dashboard.html";
    return;
  }

  // âœ… Set welcome text
  document.getElementById("welcomeName").innerText =
    "Sadri Villa â€“ Welcome " + (data.fullName || "Admin");



  // âœ… Set profile photo
  if (data.profilePhoto) {
    document.getElementById("profilePhoto").src =
      data.profilePhoto + "?v=" + Date.now();
  }

  loadDashboard();
  listenPendingRealtime();
/* ðŸ”¥ REALTIME SITE SETTINGS (Logo + Slider) */
if (!unsubscribeSiteSettings) {

  unsubscribeSiteSettings = onSnapshot(
    doc(db, "siteSettings", "home"),
    snap => {

      if (!snap.exists()) return;

      const data = snap.data();

      // âœ… LOGO
      const logo = document.getElementById("siteLogo");

if (data.logo && data.logo.url) {
  logo.src = data.logo.url + "?v=" + Date.now();
  logo.style.display = "block";
} else {
  logo.style.display = "none";
}


      // âœ… SLIDER
      const imgs = (data.sliderImages || []).filter(i => i.enabled !== false);
      const track = document.getElementById("galleryTrack");

      track.innerHTML = "";
      track.classList.remove("scrolling");

      const list = imgs.length > 1 ? [...imgs, ...imgs] : imgs;

      list.forEach(i => {
        const img = document.createElement("img");
        img.src = i.url;

        img.onclick = () => {
          document.getElementById("modalImg").src = i.url;
          document.getElementById("imgModal").style.display = "flex";
        };

        track.appendChild(img);
      });

      if (imgs.length > 1) {
        track.classList.add("scrolling");

        requestAnimationFrame(() => {
          const width = track.scrollWidth / 2;
          track.style.animationDuration = (width / 80) + "s";
        });
      }

    }
  );

}
}); 
 







/* LOAD DASHBOARD */
async function loadDashboard(){

  const snap = await getDocs(collection(db,"users"));
  cachedUsers = snap.docs.map(d=>d.data());

  totalUsers.innerText = cachedUsers.length;

  renderApprovalChart();
  renderAgeChart();
  renderProfileChart();
}

/* APPROVAL CHART */
function renderApprovalChart(){

  const approved = cachedUsers.filter(u=>u.approved===true).length;
  const pending = cachedUsers.length - approved;

  if(approvalChartInstance){
    approvalChartInstance.destroy();
  }

  approvalChartInstance = new Chart(
    document.getElementById("approvalChart"),
    {
      type:"doughnut",
      data:{
        labels:["Approved","Pending"],
        datasets:[{ data:[approved,pending] }]
      },
      options:{ responsive:true, maintainAspectRatio:false }
    }
  );
}

/* AGE CHART */
function renderAgeChart(){

  const young = cachedUsers.filter(u=>u.age && u.age<30).length;
  const adult = cachedUsers.filter(u=>u.age>=30 && u.age<50).length;
  const senior = cachedUsers.filter(u=>u.age>=50).length;

  if(ageChartInstance){
    ageChartInstance.destroy();
  }

  ageChartInstance = new Chart(
    document.getElementById("ageChart"),
    {
      type:"bar",
      data:{
        labels:["Young","Adult","Senior"],
        datasets:[{ data:[young,adult,senior] }]
      },
      options:{ responsive:true, maintainAspectRatio:false }
    }
  );
}

/* PROFILE CHART */
function renderProfileChart(){

  const completed = cachedUsers.filter(u=>u.phone && u.email).length;
  const incomplete = cachedUsers.length - completed;

  if(profileChartInstance){
    profileChartInstance.destroy();
  }

  profileChartInstance = new Chart(
    document.getElementById("profileChart"),
    {
      type:"bar",
      data:{
        labels:["Completed","Incomplete"],
        datasets:[{ data:[completed,incomplete] }]
      },
      options:{ responsive:true, maintainAspectRatio:false }
    }
  );
}
/* REALTIME BELL */
function listenPendingRealtime(){

  const q = query(
    collection(db,"users"),
    where("approved","==",false)
  );

  onSnapshot(q, snapshot => {

    let count = 0;

    snapshot.forEach(docSnap=>{
      const data = docSnap.data();
      if(data.approvalReminder === true){
        count++;
      }
    });

    const bell = document.getElementById("pendingAlertIcon");
    const badge = document.getElementById("pendingBadge");

bell.style.display = "block";

if(count > 0){
  badge.innerText = count;
  badge.style.display = "block";
} else {
  badge.style.display = "none";
}

  });
}

/* BUTTONS */
window.showAllApprovals = () => {
  location.href="admin-approval-requests.html";
};

window.showAllProfiles = () => {
  alert("Profile list feature coming soon");
};
// Close image modal
document.getElementById("imgModal").onclick = () => {
  document.getElementById("imgModal").style.display = "none";
};



  // PROFILE DROPDOWN
document.getElementById("profilePhoto").onclick=(e)=>{
  e.stopPropagation();
  document.getElementById("profileCard").classList.toggle("show");
};
document.onclick=()=>document.getElementById("profileCard").classList.remove("show");

// LOGOUT
document.getElementById("logoutBtn").onclick=async(e)=>{
  e.preventDefault();
  await signOut(auth);
  location.href="login.html";
};
 

</script>




</body>
</html>
