<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin - Villa Sections</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Playfair+Display&display=swap" rel="stylesheet">

<style>
body{
  font-family:Arial;
  background:#f3f4f6;
  padding:40px;
}

/* Card */
.container{
  max-width:1000px;
  margin:auto;
  background:white;
  padding:30px;
  border-radius:15px;
  box-shadow:0 10px 30px rgba(0,0,0,.1);
  margin-bottom:40px;
}

input, textarea, select{
  width:100%;
  padding:10px;
  margin-bottom:15px;
  border-radius:8px;
  border:1px solid #ddd;
}

button{
  background:#2563eb;
  color:white;
  padding:10px 18px;
  border:none;
  border-radius:8px;
  cursor:pointer;
}

button:hover{ background:#1d4ed8; }

.preview-box{
  margin-top:20px;
  padding:30px;
  border-radius:12px;
}

/* Popup */
.popup{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:white;
  padding:25px 40px;
  border-radius:15px;
  box-shadow:0 20px 60px rgba(0,0,0,.3);
  font-size:18px;
  display:none;
  z-index:9999;
}
.popup.success{border-left:6px solid #16a34a;}
.popup.error{border-left:6px solid #dc2626;}

/* Section List */
.section-item{
  background:#fff;
  padding:20px;
  border-radius:12px;
  margin-bottom:15px;
  box-shadow:0 5px 20px rgba(0,0,0,.08);
  display:flex;
  gap:20px;
  align-items:center;
}
.section-item img{
  width:120px;
  height:90px;
  object-fit:cover;
  border-radius:10px;
}
.section-info{flex:1;}

.section-actions button{
  margin-right:8px;
  margin-top:5px;
  font-size:13px;
  padding:6px 10px;
}

/* Preview Modal */
#previewModal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
}
.modal-content{
  width:90%;
  max-width:1000px;
  background:white;
  border-radius:15px;
  overflow:hidden;
  position:relative;
}
.modal-close{
  position:absolute;
  top:10px;
  right:15px;
  background:red;
  color:white;
  border:none;
  padding:6px 10px;
  border-radius:6px;
  cursor:pointer;
}

/* Keep left-right layout always */
@media(max-width:900px){
  .section-item{
    flex-direction:row;
  }
}
</style>
</head>

<body>

<div class="container">
<h2>Add Villa Section</h2>

<input type="text" id="title" placeholder="Title">
<textarea id="description" rows="4" placeholder="Description"></textarea>

<label>Upload Image</label>
<input type="file" id="image">
<img id="imagePreview" style="max-width:200px;display:none;margin-bottom:15px;">

<label>Background Color</label>
<input type="color" id="bgColor" value="#ffffff">

<label>Text Color</label>
<input type="color" id="textColor" value="#000000">

<label>Font Style</label>
<select id="fontFamily">
<option value="inherit">Default</option>
<option value="'Pacifico', cursive">Pacifico</option>
<option value="'Playfair Display', serif">Playfair</option>
</select>

<label>Order</label>
<input type="number" id="order" value="1">

<label>
<input type="checkbox" id="enabled" checked> Enabled
</label>

<br><br>
<button onclick="saveSection()">Save Section</button>

<h3 style="margin-top:30px;">Live Preview</h3>
<div id="livePreview" class="preview-box"></div>

</div>

<div class="container">
<h2>Existing Sections</h2>
<div id="existingSections"></div>
</div>

<div id="popup" class="popup"></div>

<!-- Preview Modal -->
<div id="previewModal">
  <div class="modal-content">
    <button class="modal-close" onclick="closePreview()">X</button>
    <div id="previewContent"></div>
  </div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot, doc, updateDoc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const app = initializeApp({
  apiKey:"AIzaSyC7gkT4F_dRJpWfef12y6cwV3F2PTMJ6fY",
  authDomain:"sadri-villa-14c06.firebaseapp.com",
  projectId:"sadri-villa-14c06",
  storageBucket:"sadri-villa-14c06.appspot.com"
});

const db = getFirestore(app);
const storage = getStorage(app);
const auth = getAuth(app);

/* AUTH */
onAuthStateChanged(auth,(user)=>{
  if(!user){
    alert("Login required");
    window.location.href="login.html";
  }
});

/* Popup */
function showPopup(msg,type){
  const p=document.getElementById("popup");
  p.innerText=msg;
  p.className="popup "+type;
  p.style.display="block";
  setTimeout(()=>p.style.display="none",3000);
}

/* Image Preview */
document.getElementById("image").addEventListener("change",e=>{
  const file=e.target.files[0];
  if(file){
    const reader=new FileReader();
    reader.onload=ev=>{
      const img=document.getElementById("imagePreview");
      img.src=ev.target.result;
      img.style.display="block";
    };
    reader.readAsDataURL(file);
  }
});

/* Live Preview */
["title","description","bgColor","textColor","fontFamily"].forEach(id=>{
  document.getElementById(id).addEventListener("input",updatePreview);
});
function updatePreview(){
  const t=title.value;
  const d=description.value;
  const bg=bgColor.value;
  const c=textColor.value;
  const f=fontFamily.value;
  livePreview.style.background=bg;
  livePreview.style.color=c;
  livePreview.style.fontFamily=f;
  livePreview.innerHTML=`<h2>${t||"Title Preview"}</h2><p>${d||"Description Preview"}</p>`;
}

/* Save */
window.saveSection=async function(){
try{
  if(!title.value || !description.value){
    showPopup("Title & Description required","error");
    return;
  }

  let imageUrl="";
  if(image.files[0]){
    const imageRef=ref(storage,"villaSections/"+Date.now()+"_"+image.files[0].name);
    await uploadBytes(imageRef,image.files[0]);
    imageUrl=await getDownloadURL(imageRef);
  }

  await addDoc(collection(db,"villaSections"),{
    title:title.value,
    description:description.value,
    imageUrl,
    backgroundColor:bgColor.value,
    textColor:textColor.value,
    fontFamily:fontFamily.value,
    order:Number(order.value),
    enabled:enabled.checked,
    createdAt:serverTimestamp()
  });

  showPopup("Section Saved","success");

}catch(err){
  showPopup(err.message,"error");
}
};

/* Load Existing */
const list=document.getElementById("existingSections");

onSnapshot(query(collection(db,"villaSections"),orderBy("order")),snap=>{
  list.innerHTML="";
  snap.forEach(docSnap=>{
    const data=docSnap.data();

    const div=document.createElement("div");
    div.className="section-item";

    div.innerHTML=`
      <img src="${data.imageUrl || ''}">
      <div class="section-info">
        <strong>${data.title}</strong> (Order: ${data.order})<br>
        Status: ${data.enabled?"Enabled":"Disabled"}
      </div>
      <div class="section-actions">
        <button onclick='openPreview(${JSON.stringify(data)})'>Preview</button>
        <button onclick="toggleSection('${docSnap.id}',${data.enabled})">
          ${data.enabled?"Disable":"Enable"}
        </button>
        <button onclick="deleteSection('${docSnap.id}','${data.imageUrl}')">
          Delete
        </button>
      </div>
    `;
    list.appendChild(div);
  });
});

/* Toggle */
window.toggleSection=async function(id,current){
  await updateDoc(doc(db,"villaSections",id),{enabled:!current});
};

/* Delete */
window.deleteSection=async function(id,imageUrl){
  if(!confirm("Delete section?")) return;
  await deleteDoc(doc(db,"villaSections",id));
  if(imageUrl){
    const imgRef=ref(storage,imageUrl);
    await deleteObject(imgRef);
  }
};

/* Preview Modal */
window.openPreview=function(data){
  previewContent.innerHTML=`
  <div style="
  display:flex;
  gap:40px;
  padding:60px;
  background:${data.backgroundColor};
  color:${data.textColor};
  font-family:${data.fontFamily};
  ">
    <div style="flex:1;">
      <img src="${data.imageUrl}" style="width:100%;border-radius:20px;">
    </div>
    <div style="flex:1;">
      <h2>${data.title}</h2>
      <p>${data.description}</p>
    </div>
  </div>
  `;
  previewModal.style.display="flex";
};

window.closePreview=function(){
  previewModal.style.display="none";
};

</script>
</body>
</html>
